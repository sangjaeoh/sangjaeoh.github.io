<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>📖 도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지 | Stack O Flow</title>
<meta name="description" content="도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지 책을 읽고 내용을 아주 간단하게 정리한 글입니다. 책에는 자세한 설명과 예제가 많으니 꼭 구입해서 읽는것을 추천합니다~👍">


  <meta name="author" content="Sangjae Oh">
  
  <meta property="article:author" content="Sangjae Oh">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="Stack O Flow">
<meta property="og:title" content="📖 도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지">
<meta property="og:url" content="http://localhost:4000/etc/books/%EB%8F%84%EB%A9%94%EC%9D%B8%EC%A3%BC%EB%8F%84%EA%B0%9C%EB%B0%9C%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/">


  <meta property="og:description" content="도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지 책을 읽고 내용을 아주 간단하게 정리한 글입니다. 책에는 자세한 설명과 예제가 많으니 꼭 구입해서 읽는것을 추천합니다~👍">







  <meta property="article:published_time" content="2023-01-09T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/etc/books/%EB%8F%84%EB%A9%94%EC%9D%B8%EC%A3%BC%EB%8F%84%EA%B0%9C%EB%B0%9C%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Sangjae Oh",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Stack O Flow Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->


<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon.png">
<!-- <link rel="manifest" href="/assets/logo.ico/site.webmanifest"> -->
<link rel="mask-icon" href="/assets/images/favicon.png" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo.png" alt="Stack O Flow"></a>
        
        <a class="site-title" href="/">
          Stack O Flow
          <span class="site-subtitle">복붙노트</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/">카테고리</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">태그</a>
            </li><li class="masthead__menu-item">
              <a href="/search/">🔎</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">Sangjae Oh</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>안녕하세요~🙇🏻‍♂️</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:sangjaeoh91.gmail.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/sangjaeoh" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">토글 메뉴</label>
  
  <ul class="nav__items">
    
    <li>
      <a href="http://localhost:4000/categories/"><span class="nav__sub-title" style="border-bottom: 0px;">전체 (14)</span></a>
    </li>

    
      <li>
        
          <a href="/categories/os"><span class="nav__sub-title">os</span></a>
        

        
        <ul>
          
          
            <li><a href="/categories/os/mac">mac (1)</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <a href="/categories/etc"><span class="nav__sub-title">기타</span></a>
        

        
        <ul>
          
          
            <li><a href="/categories/etc/books">책 (2)</a></li>
          
          
            <li><a href="/categories/etc/education">교육 (9)</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="📖 도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지">
    <meta itemprop="description" content="도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지 책을 읽고 내용을 아주 간단하게 정리한 글입니다. 책에는 자세한 설명과 예제가 많으니 꼭 구입해서 읽는것을 추천합니다~👍">
    <meta itemprop="datePublished" content="2023-01-09T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="http://localhost:4000/etc/books/%EB%8F%84%EB%A9%94%EC%9D%B8%EC%A3%BC%EB%8F%84%EA%B0%9C%EB%B0%9C%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/" class="u-url" itemprop="url">📖 도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-01-09T00:00:00+09:00">2023-01-09</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 목차</h4></header>
              <ul class="toc__menu"><li><a href="#1-도메인-모델-시작하기">1. 도메인 모델 시작하기</a><ul><li><a href="#11-도메인이란">1.1 도메인이란?</a></li><li><a href="#12-도메인-전문가와-개발자-간-지식공유">1.2 도메인 전문가와 개발자 간 지식공유</a></li><li><a href="#13-도메인-모델">1.3 도메인 모델</a></li><li><a href="#14-도메인-모델-패턴">1.4 도메인 모델 패턴</a></li><li><a href="#15-도메인-모델-도출">1.5 도메인 모델 도출</a></li><li><a href="#16-엔티티와-벨류">1.6 엔티티와 벨류</a><ul><li><a href="#161-엔티티">1.6.1 엔티티</a></li><li><a href="#162-엔티티의-식별자-생성">1.6.2 엔티티의 식별자 생성</a></li><li><a href="#163-밸류-타입">1.6.3 밸류 타입</a></li><li><a href="#164-엔티티-식별자와-밸류-타입">1.6.4 엔티티 식별자와 밸류 타입</a></li><li><a href="#165-도메인-모델에-set-넣지-않기">1.6.5 도메인 모델에 set 넣지 않기</a></li></ul></li><li><a href="#17-도메인-용어와-유비쿼터스-언어">1.7 도메인 용어와 유비쿼터스 언어</a></li></ul></li><li><a href="#2-아키택처-개요">2. 아키택처 개요</a><ul><li><a href="#21-네-개의-영역">2.1 네 개의 영역</a></li><li><a href="#22-계층-구조-아키텍처">2.2 계층 구조 아키텍처</a></li><li><a href="#23-dip">2.3 DIP</a></li><li><a href="#24-도메인-영역의-주요-구성요소">2.4 도메인 영역의 주요 구성요소</a></li><li><a href="#25-요청-처리-흐름">2.5 요청 처리 흐름</a></li><li><a href="#26-인프라스트럭처-개요">2.6 인프라스트럭처 개요</a></li><li><a href="#27-모듈-구성">2.7 모듈 구성</a></li></ul></li><li><a href="#3-애그리거트">3. 애그리거트</a><ul><li><a href="#31-애그리거트">3.1 애그리거트</a></li><li><a href="#32-애그리거트-루트">3.2 애그리거트 루트</a><ul><li><a href="#321-도메인-규칙과-일관성">3.2.1 도메인 규칙과 일관성</a></li><li><a href="#322-애그리거트-루트의-기능-구현">3.2.2 애그리거트 루트의 기능 구현</a></li><li><a href="#323-트랜젝션-범위">3.2.3 트랜젝션 범위</a></li></ul></li><li><a href="#33-리포지터리와-애그리거트">3.3 리포지터리와 애그리거트</a></li><li><a href="#34-id를-이용한-애그리거트-참조">3.4 ID를 이용한 애그리거트 참조</a><ul><li><a href="#341-id를-이용한-참조와-조회-성능">3.4.1 ID를 이용한 참조와 조회 성능</a></li></ul></li><li><a href="#35-애그리거트-간-집합-연관">3.5 애그리거트 간 집합 연관</a></li><li><a href="#36-애그리거트를-팩토리로-사용하기">3.6 애그리거트를 팩토리로 사용하기</a></li></ul></li><li><a href="#4-리포지터리와-모델-구현">4. 리포지터리와 모델 구현</a><ul><li><a href="#41-jpa를-이용한-리포지터리-구현">4.1 JPA를 이용한 리포지터리 구현</a><ul><li><a href="#411-모듈-위치">4.1.1 모듈 위치</a></li><li><a href="#412-리포지터리-기본-기능-구현">4.1.2 리포지터리 기본 기능 구현</a></li></ul></li><li><a href="#42-스프링-데이터-jpa를-이용한-리포지터리-구현">4.2 스프링 데이터 JPA를 이용한 리포지터리 구현</a></li><li><a href="#43-매핑-구현">4.3 매핑 구현</a><ul><li><a href="#431-엔티티와-밸류-기본-매핑-구현">4.3.1 엔티티와 밸류 기본 매핑 구현</a></li><li><a href="#432-기본-생성자">4.3.2 기본 생성자</a></li><li><a href="#432-필드-접근-방식-사용">4.3.2 필드 접근 방식 사용</a></li><li><a href="#434-attributeconverter를-이용한-밸류-매핑-처리">4.3.4 AttributeConverter를 이용한 밸류 매핑 처리</a></li><li><a href="#435-밸류-컬렉션-별도-테이블-매핑">4.3.5 밸류 컬렉션: 별도 테이블 매핑</a></li><li><a href="#436-밸류-컬렉션-한-개-컬럼-매핑">4.3.6 밸류 컬렉션: 한 개 컬럼 매핑</a></li><li><a href="#437-밸류를-이용한-id-매핑">4.3.7 밸류를 이용한 ID 매핑</a></li><li><a href="#438-별도-테이블에-저장하는-밸류-매핑">4.3.8 별도 테이블에 저장하는 밸류 매핑</a></li><li><a href="#439-밸류-컬렉션을-entity로-매핑하기">4.3.9 밸류 컬렉션을 @Entity로 매핑하기</a></li><li><a href="#4310-id-참조와-조인-테이블을-이용한-단방향-m-n-매핑">4.3.10 ID 참조와 조인 테이블을 이용한 단방향 M-N 매핑</a></li></ul></li><li><a href="#44-애그리거트-로딩-전략">4.4 애그리거트 로딩 전략</a></li><li><a href="#45-애그리거트-영속성-전파">4.5 애그리거트 영속성 전파</a></li><li><a href="#46-식별자-생성-기능">4.6 식별자 생성 기능</a></li><li><a href="#47-도메인-구현과-dip">4.7 도메인 구현과 DIP</a></li></ul></li><li><a href="#5-스프링-데이터-jpa를-이용한-조회-기능">5. 스프링 데이터 JPA를 이용한 조회 기능</a><ul><li><a href="#51-시작에-앞서">5.1 시작에 앞서</a></li><li><a href="#52-검색을-위한-스펙">5.2 검색을 위한 스펙</a></li><li><a href="#53-스프링-데이터-jpa를-이용한-스펙-구현">5.3 스프링 데이터 JPA를 이용한 스펙 구현</a></li><li><a href="#54-리포지터리dao에서-스펙-사용하기">5.4 리포지터리/DAO에서 스펙 사용하기</a></li><li><a href="#55-스펙-조합">5.5 스펙 조합</a></li><li><a href="#56-정렬-지정하기">5.6 정렬 지정하기</a></li><li><a href="#57-페이징-처리하기">5.7 페이징 처리하기</a></li><li><a href="#58-스펙-조합을-위한-스펙-빌더-클래스">5.8 스펙 조합을 위한 스펙 빌더 클래스</a></li><li><a href="#59-동적-인스턴스-생성">5.9 동적 인스턴스 생성</a></li><li><a href="#510-하이버네이트-subselect-사용">5.10 하이버네이트 @Subselect 사용</a></li></ul></li><li><a href="#6-응용-서비스와-표현-영역">6. 응용 서비스와 표현 영역</a><ul><li><a href="#61-표현-영역과-응용-영역">6.1 표현 영역과 응용 영역</a></li><li><a href="#62-응용-서비스의-역할">6.2 응용 서비스의 역할</a><ul><li><a href="#621-도메인-로직-넣지-않기">6.2.1 도메인 로직 넣지 않기</a></li></ul></li><li><a href="#63-응용-서비스의-구현">6.3 응용 서비스의 구현</a><ul><li><a href="#631-응용-서비스의-크기">6.3.1 응용 서비스의 크기</a></li><li><a href="#632-응용-서비스의-인터페이스와-클래스">6.3.2 응용 서비스의 인터페이스와 클래스</a></li><li><a href="#633-메서드-파라미터와-값-리턴">6.3.3 메서드 파라미터와 값 리턴</a></li><li><a href="#634-표현-영역에-의존하지-않기">6.3.4 표현 영역에 의존하지 않기</a></li><li><a href="#635-트랜잭션-처리">6.3.5 트랜잭션 처리</a></li></ul></li><li><a href="#64-표현-영역">6.4 표현 영역</a></li><li><a href="#65-값-검증">6.5 값 검증</a></li><li><a href="#66-권한-검사">6.6 권한 검사</a></li><li><a href="#67-조회-전용-기능과-응용-서비스">6.7 조회 전용 기능과 응용 서비스</a></li></ul></li><li><a href="#7-도메인-서비스">7. 도메인 서비스</a><ul><li><a href="#71-여러-애그리거트가-필요한-기능">7.1 여러 애그리거트가 필요한 기능</a></li><li><a href="#72-도메인-서비스">7.2 도메인 서비스</a><ul><li><a href="#721-계산-로직과-도메인-서비스">7.2.1 계산 로직과 도메인 서비스</a></li><li><a href="#722-외부-시스템-연동과-도메인-서비스">7.2.2 외부 시스템 연동과 도메인 서비스</a></li><li><a href="#723-도메인-서비스의-패키지-위치">7.2.3 도메인 서비스의 패키지 위치</a></li><li><a href="#724-도메인-서비스의-인터페이스와-클래스">7.2.4 도메인 서비스의 인터페이스와 클래스</a></li></ul></li></ul></li><li><a href="#8-애그리거트-트랜잭션-관리">8. 애그리거트 트랜잭션 관리</a><ul><li><a href="#81-애그리거트와-트랜잭션">8.1 애그리거트와 트랜잭션</a></li><li><a href="#82-선점-잠금">8.2 선점 잠금</a><ul><li><a href="#821-선점-잠금과-교착-상태">8.2.1 선점 잠금과 교착 상태</a></li></ul></li><li><a href="#83-비선점-잠금">8.3 비선점 잠금</a><ul><li><a href="#831-강제-버전-증가">8.3.1 강제 버전 증가</a></li></ul></li><li><a href="#84-오프라인-선점-잠금">8.4 오프라인 선점 잠금</a><ul><li><a href="#841-오프라인-선점-잠금을-위한-lockmanager-인터페이스와-관련-클래스">8.4.1 오프라인 선점 잠금을 위한 LockManager 인터페이스와 관련 클래스</a></li><li><a href="#842-db를-이용한-lockmanager-구현">8.4.2 DB를 이용한 LockManager 구현</a></li></ul></li></ul></li><li><a href="#9-도메인-모델과-바운디드-컨텍스트">9. 도메인 모델과 바운디드 컨텍스트</a><ul><li><a href="#91-도메인-모델과-경계">9.1 도메인 모델과 경계</a></li><li><a href="#92-바운디드-컨텍스트">9.2 바운디드 컨텍스트</a></li><li><a href="#93-바운디드-컨텍스트-구현">9.3 바운디드 컨텍스트 구현</a></li><li><a href="#94-바운디드-컨텍스트-간-통합">9.4 바운디드 컨텍스트 간 통합</a></li><li><a href="#95-바운디드-컨텍스트-간-관계">9.5 바운디드 컨텍스트 간 관계</a></li><li><a href="#96-컨텍스트-맵">9.6 컨텍스트 맵</a></li></ul></li><li><a href="#10-이벤트">10. 이벤트</a><ul><li><a href="#101-시스템-간-강결합-문제">10.1 시스템 간 강결합 문제</a></li><li><a href="#102-이벤트-개요">10.2 이벤트 개요</a><ul><li><a href="#1021-이벤트-관련-구성요소">10.2.1 이벤트 관련 구성요소</a></li><li><a href="#1022-이벤트의-구성">10.2.2 이벤트의 구성</a></li><li><a href="#1023-이벤트-용도">10.2.3 이벤트 용도</a></li><li><a href="#1024-이벤트-장점">10.2.4 이벤트 장점</a></li></ul></li><li><a href="#103-이벤트-핸들러-디스패처-구현">10.3 이벤트, 핸들러, 디스패처 구현</a><ul><li><a href="#1031-이벤트-클래스">10.3.1 이벤트 클래스</a></li><li><a href="#1032-events-클래스와-applicationeventpublisher">10.3.2 Events 클래스와 ApplicationEventPublisher</a></li><li><a href="#1033-이벤트-발생과-이벤트-핸들러">10.3.3 이벤트 발생과 이벤트 핸들러</a></li><li><a href="#1034-흐름-정리">10.3.4 흐름 정리</a></li></ul></li><li><a href="#104-동기-이벤트-처리-문제">10.4 동기 이벤트 처리 문제</a></li><li><a href="#105-비동기-이벤트-처리">10.5 비동기 이벤트 처리</a><ul><li><a href="#1051-로컬-핸들러-비동기-실행">10.5.1 로컬 핸들러 비동기 실행</a></li><li><a href="#1052-메시징-시스템을-이용한-비동기-구현">10.5.2 메시징 시스템을 이용한 비동기 구현</a></li><li><a href="#1053-이벤트-저장소를-이용한-비동기-처리">10.5.3 이벤트 저장소를 이용한 비동기 처리</a></li></ul></li><li><a href="#106-이벤트-적용-시-추가-고려-사항">10.6 이벤트 적용 시 추가 고려 사항</a><ul><li><a href="#1061-이벤트-처리와-db-트랜잭션-고려">10.6.1 이벤트 처리와 DB 트랜잭션 고려</a></li></ul></li></ul></li><li><a href="#11-cqrs">11. CQRS</a><ul><li><a href="#111-단일-모델의-단점">11.1 단일 모델의 단점</a></li><li><a href="#112-cqrs">11.2 CQRS</a><ul><li><a href="#1121-웹과-cqrs">11.2.1 웹과 CQRS</a></li><li><a href="#1122-cqrs-장단점">11.2.2 CQRS 장단점</a></li></ul></li></ul></li></ul>

            </nav>
          </aside>
        
        <p><a href="https://product.kyobobook.co.kr/detail/S000001810495" target="_blank">도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지</a> 책을 읽고 내용을 아주 간단하게 정리한 글입니다. 책에는 자세한 설명과 예제가 많으니 <strong>꼭 구입해서 읽는것을 추천</strong>합니다~👍</p>

<hr />

<h1 id="1-도메인-모델-시작하기">1. 도메인 모델 시작하기</h1>
<h2 id="11-도메인이란">1.1 도메인이란?</h2>
<p>소프트웨어로 해결하고자 하는 문제 영역을 도메인이라 한다.</p>

<h2 id="12-도메인-전문가와-개발자-간-지식공유">1.2 도메인 전문가와 개발자 간 지식공유</h2>
<p>전문가나 관련자가 요구한 내용이 항상 올바른 것은 아니다. 그래서 개발자는 요구사항을 이해할 때 왜 이런 기능을 요구하는지 또는 실제로 원하는게 무엇인지 생각하고 전문가와 대화를 통해 진짜로 원하는 것을 찾아야 한다.</p>

<h2 id="13-도메인-모델">1.3 도메인 모델</h2>
<p>도메인 모델은 특정 도메인을 개념적으로 표현한 것이다. 도메인 모델을 사용하면 여러 관계자들이 동일한 모습으로 도메인을 이해하고 도메인 지식을 공유하는데 도움이 된다. 도메인 모델을 이해하는 데 도움이 된다면 객체기반 표현이든, 함수 표현이든 표현 방식이 무엇인지는 중요하지 않다.</p>
<center><img src="/assets/images/posts/books/1/1_3_객체기반도메인모델.png" alt="객체기반도메인모델" width="100%" height="100%" /></center>
<center><img src="/assets/images/posts/books/1/1_3_상태다이어그램도메인모델.png" alt="상태다이어그램도메인모델" width="100%" height="100%" /></center>

<h2 id="14-도메인-모델-패턴">1.4 도메인 모델 패턴</h2>
<center><img src="/assets/images/posts/books/1/1_4_아키텍처구성.png" alt="아키텍처구성" width="70%" height="70%" /></center>

<table>
  <thead>
    <tr>
      <th>영역</th>
      <th>설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>사용자 인터페이스(UI) 또는 표현(Presentation)</td>
      <td>사용자의 요청을 처리하고 사용자에게 정보를 보여준다. 여기서 사용자는 소프트웨어를 사용하는 사람뿐만 아니라 외부 시스템일 수도 있다.</td>
    </tr>
    <tr>
      <td>응용(Application)</td>
      <td>사용자가 요청한 기능을 실행한다. 업무 로직을 직접 구현하지 않으며 도메인 계층을 조합해서 기능을 실행한다.</td>
    </tr>
    <tr>
      <td>도메인(Domain)</td>
      <td>시스템이 제공할 도메인 규칙을 구현한다.</td>
    </tr>
    <tr>
      <td>인프라스트럭처(Infrastructure)</td>
      <td>데이터베이스나 메시징 시스템과 같은 외부 시스템과의 연동을 처리한다.</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<p><strong>개념 모델과 구현 모델</strong><br />
<strong>개념 모델은 순수하게 문제를 분석한 결과물</strong>이다. 개념 모델은 데이터베이스, 트랜잭션 처리, 성능, 구현 기술과 같은 것을 고려하고 있지 않기 때문에 실제 코드를 작성할 때 개념 모델을 있는 그대로 사용할 수 없다. 그래서 개념 모델을 구현 가능한 형태의 모델로 전환하는 과정을 거치게 된다.</p>

<p><strong>처음부터 완벽한 개념 모델을 만들기보다는 전반적인 개요를 알 수 있는 수준으로 개념 모델을 작성</strong>해야한다. 프로젝트 초기에는 개요 수준의 개념 모델로 도메인에 대한 전체 윤곽을 이해하는 데 집중하고, <strong>구현하는 과정에서 개념 모델을 구현 모델로 점진적으로 발전</strong>시켜 나가야 한다.</p>

<h2 id="15-도메인-모델-도출">1.5 도메인 모델 도출</h2>
<p>도메인을 모델링할 때 기본이 되는 작업은 <strong>모델을 구성하는 핵심 구성요소, 규칙, 기능을 찾는 것</strong>이다. 이 과정은 요구사항에서 출발한다. <strong>요구사항을 통해 도메인 모델을 점진적으로 만들어 나간다</strong>. 이렇게 만든 모델은 요구사항 정련을 위해 도메인 전문가나 다른 개발자와 논의하는 과정에서 공유되기도 한다. 모델을 공유할 때는 화이트보드나 위키 같은 도구를 사용해서 누구나 쉽게 접근할 수 있도록 하면 좋다.</p>

<h2 id="16-엔티티와-벨류">1.6 엔티티와 벨류</h2>
<h3 id="161-엔티티">1.6.1 엔티티</h3>
<ul>
  <li>식별자를 가진다.</li>
  <li>식별자는 엔티티 객체마다 고유하다.</li>
</ul>

<h3 id="162-엔티티의-식별자-생성">1.6.2 엔티티의 식별자 생성</h3>
<ul>
  <li>특정 규칙에 따라 생성.</li>
  <li>UUID나 Nano ID와 같은 고유 식별자 생성기 사용.</li>
  <li>값을 직접 입력.</li>
  <li>일련번호 사용(시퀀스나 DB의 자동 증가 컬럼 사용).</li>
</ul>

<h3 id="163-밸류-타입">1.6.3 밸류 타입</h3>
<ul>
  <li>밸류 타입은 개념적으로 완전한 하나를 표현할 때 사용한다.</li>
  <li>의미를 명확하게 표현하기 위해 사용되기도 한다.</li>
  <li>밸류 타입을 위한 기능을 추가할 수 있다.</li>
  <li>불변으로 구현한다.</li>
</ul>

<h3 id="164-엔티티-식별자와-밸류-타입">1.6.4 엔티티 식별자와 밸류 타입</h3>
<ul>
  <li>식별자를 위한 밸류 타입을 사용해서 의미가 잘 드러나도록 할 수 있다.</li>
</ul>

<h3 id="165-도메인-모델에-set-넣지-않기">1.6.5 도메인 모델에 set 넣지 않기</h3>
<ul>
  <li>상태 변경을 위한 set 사용시 도메인 지식이 코드에서 사라진다.</li>
  <li>객체를 생성할 때 온전하지 않은 상태가 될 수 있다.</li>
</ul>

<p><strong>DTO도 최대한 불변 객체로 사용하도록 하자</strong></p>

<h2 id="17-도메인-용어와-유비쿼터스-언어">1.7 도메인 용어와 유비쿼터스 언어</h2>
<p><strong>도메인 용어</strong><br />
STEP1, STEP2 같은것이 아닌 PAYMENT_WAITING, PREPARING 같은 도메인 용어를 사용하여 코드를 작성한다.</p>

<p><strong>유비쿼터스 언어</strong><br />
전문가, 관계자 개발자가 도메인과 관련된 공통의 언어를 만들고 이를 대화, 문서, 도메인 모델, 코드 테스트 등 모든 곳에서 같은 용어를 사용한다. 이렇게 하면 소통 과정에서 발생하는 용어의 모호함을 줄일 수 있고 개발자는 도메인과 코드 사이에서 불필요한 해석 과정을 줄일 수 있다.</p>

<p><br />
<br />
<br /></p>

<h1 id="2-아키택처-개요">2. 아키택처 개요</h1>
<h2 id="21-네-개의-영역">2.1 네 개의 영역</h2>
<p><strong>표현 영역</strong><br />
사용자의 요청을 받아 응용 영역에 전달하고 응용 영역의 처리 결과를 다시 사용자에게 보여주는 역할</p>
<center><img src="/assets/images/posts/books/1/2_1_표현영역.png" alt="표현영역" width="80%" height="80%" /></center>

<p><br /></p>

<p><strong>응용 영역</strong><br />
표현 영역을 통해 요청을 전달받아 시스템이 사용자에게 제공해야 할 기능을 구현하는 역할. 로직을 직접 수행하기보다는 도메인 모델에 로직 수행을 위임한다.</p>
<center><img src="/assets/images/posts/books/1/2_1_응용영역.png" alt="응용영역" width="80%" height="80%" /></center>

<p><br /></p>

<p><strong>도메인 영역</strong><br />
도메인 모델을 구현. 도메인 모델은 도메인의 핵심 로직을 구현한다.</p>

<p><br /></p>

<p><strong>인프라스트럭처 영역</strong><br />
구현 기술에 대한 것을 다룬다. 이 영역은 논리적인 개념을 표현하기보다는 실제 구현을 다룬다.</p>
<center><img src="/assets/images/posts/books/1/2_1_인프라스트럭처영역.png" alt="인프라스트럭처영역" width="60%" height="60%" /></center>

<h2 id="22-계층-구조-아키텍처">2.2 계층 구조 아키텍처</h2>
<center><img src="/assets/images/posts/books/1/2_2_계층구조.png" alt="계층구조" width="60%" height="60%" /></center>
<center><img src="/assets/images/posts/books/1/2_2_계층구조상의존관계.png" alt="계층구조상의존관계" width="60%" height="60%" /></center>
<ul>
  <li>상위 계층에서 하위 계층으로 의존만 존재하고 하위 계층에서 상위 계층에 의존하지 않는다.</li>
</ul>

<h2 id="23-dip">2.3 DIP</h2>
<p>DIP(Dependency Inversion Principle) 의존성 역전 원칙</p>

<center><img src="/assets/images/posts/books/1/2_3_고수준저수준.png" alt="고수준저수준" width="60%" height="60%" /></center>
<center><img src="/assets/images/posts/books/1/2_3_고수준저수준2.png" alt="고수준저수준2" width="60%" height="60%" /></center>
<center><img src="/assets/images/posts/books/1/2_3_고수준저수준3.png" alt="고수준저수준3" width="60%" height="60%" /></center>
<center><img src="/assets/images/posts/books/1/2_3_DIP.png" alt="DIP" width="70%" height="70%" /></center>

<h2 id="24-도메인-영역의-주요-구성요소">2.4 도메인 영역의 주요 구성요소</h2>

<table>
  <thead>
    <tr>
      <th><strong>요소</strong></th>
      <th><strong>설명</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>엔티티 ENTITY</td>
      <td>고유의 식별자를 갖는 객체로 자신의 라이프 사이클을 갖는다. 주문, 회원, 상품과 같이 도메인의 고유한 개념을 표현한다. 도메인 모델의 데이터를 포함하며 해당 데이터와 관련된 기능을 함께 제공한다.</td>
    </tr>
    <tr>
      <td>밸류 VALUE</td>
      <td>고유의 식별자를 갖지 않는 객체로 주로 개념적으로 하나인 값을 표현한다. 엔티티의 속성으로 사용할 뿐만 아니라 다른 밸류 타입의 속성으로도 사용할 수 있다.</td>
    </tr>
    <tr>
      <td>애그리거트 AGGREGATE</td>
      <td>연관된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것이다. 예를 들어 주문과 관련된 Order 엔티티, OrderLine 밸류, Orderer 밸류 객체를 ‘주문’ 애그리거트로 묶을 수 있다.</td>
    </tr>
    <tr>
      <td>리포지터리 REPOSITORY</td>
      <td>도메인 모델의 영속성을 처리한다. 예를 들어 DBMS 테이블에서 엔티티 객체를 로딩하거나 저장하는 기능을 제공한다.</td>
    </tr>
    <tr>
      <td>도메인 서비스 DOMAIN SERVICE</td>
      <td>특정 엔티티에 속하지 않은 도메인 로직을 제공한다. 도메인 로직이 여러 엔티티와 밸류를 필요로 하면 도메인 서비스에서 로직을 구현한다.</td>
    </tr>
  </tbody>
</table>

<h2 id="25-요청-처리-흐름">2.5 요청 처리 흐름</h2>
<center><img src="/assets/images/posts/books/1/2_5_요청처리흐름.png" alt="요청처리흐름" width="80%" height="80%" /></center>

<h2 id="26-인프라스트럭처-개요">2.6 인프라스트럭처 개요</h2>
<ul>
  <li>도메인 객체의 영속성 처리, 트랜젝션, REST 클라이언트 등 다른영역에서 필요로 하는 프레임워크, 구현 기술, 보조 기능을 지원한다.</li>
  <li>보통 의존성역전 사용</li>
  <li>@Transactional 같은 DIP를 사용하지 않는 예외도 편의를 위해 허용</li>
</ul>

<h2 id="27-모듈-구성">2.7 모듈 구성</h2>
<center><img src="/assets/images/posts/books/1/2_7_모듈구성1.png" alt="모듈구성1" width="80%" height="80%" /></center>
<center><img src="/assets/images/posts/books/1/2_7_모듈구성2.png" alt="모듈구성2" width="80%" height="80%" /></center>
<center><img src="/assets/images/posts/books/1/2_7_모듈구성3.png" alt="모듈구성3" width="80%" height="80%" /></center>

<p><br />
<br />
<br /></p>

<h1 id="3-애그리거트">3. 애그리거트</h1>
<h2 id="31-애그리거트">3.1 애그리거트</h2>
<p>복잡한 도메인을 이해하고 관리하기 쉬운 단위로 만드려면 상위 수준에서 모델을 조망할 수 있는 방법이 필요한데, 그 방법이 바로 애그리거트다. 애그리거트는 관련된 객체를 하나의 군으로 묶어 준다.</p>
<center><img src="/assets/images/posts/books/1/3_1_애거리거트모델.png" alt="애거리거트모델" width="80%" height="80%" /></center>

<p>애그리거트는 경계를 갖는다. 한 애그리거트에 속한 객체는 다른 애그리거트에 속하지 않는다. 애그리거트는 독립된 객체 군이며 각 애그리거트는 자기 자신을 관리할 뿐 다른 애그리거트를 관리하지 않는다. 경계를 설정할 때 기본이 되는 것은 도메인 규칙과 요구사항이다. 도메인 규칙에 따라 함께 생성되는 구성요소는 한 애그리거트에 속할 가능성이 높다.</p>

<h2 id="32-애그리거트-루트">3.2 애그리거트 루트</h2>
<p>애그리거트에 속한 모든 객체가 일관된 상태를 유지하려면 애그리거트 전체를 관리할 주체가 필요한데, 이 책임을 지는 것이 바로 애그리거트 루트 엔티티이다. 애그리거트에 속한 객체는 애그리거트 루트 엔티티에 직접 또는 간접적으로 속하게 된다.</p>
<center><img src="/assets/images/posts/books/1/3_2_애그리거트루트.png" alt="애그리거트루트" width="80%" height="80%" /></center>

<h3 id="321-도메인-규칙과-일관성">3.2.1 도메인 규칙과 일관성</h3>
<ul>
  <li>애그리거트 루트의 핵심 역할은 애그리거트의 일관성이 깨지지 않도록 하는 것이다. 이를 위해 애그리거트 루트는 애그리거트가 제공해야 할 도메인 기능을 구현한다.</li>
  <li>애그리거트 외부에서 애그리거트에 속한 객체를 직접 변경하면 안된다. 이것은 모델의 일관성을 깨는 원인이 된다.</li>
  <li>단순히 필드를 변경하는 set 메서드를 공개(public) 범위로 만들지 않는다.</li>
  <li>밸류 타입은 불변으로 구현한다.</li>
</ul>

<h3 id="322-애그리거트-루트의-기능-구현">3.2.2 애그리거트 루트의 기능 구현</h3>
<ul>
  <li>애그리거트 루트는 애그리거트 내부의 다른 객체를 조합해 기능을 완성한다.</li>
  <li>애그리거트 루트가 구성요소의 상태만 참조하는 것은 아니다. 기능 실행을 위임하기도 한다.</li>
</ul>

<h3 id="323-트랜젝션-범위">3.2.3 트랜젝션 범위</h3>
<ul>
  <li>작을수록 좋다</li>
  <li>한 트랜젝션에서는 한 개의 애그리거트만 수정한다.</li>
  <li>부득이하게 한 트랜젝션으로 두 개 이상의 애그리거트를 수정해야 한다면 애그리거트에서 다른 애그리거트를 수정하지 말고, 응용 서비스에서 애그리거트를 수정하도록 구현한다.</li>
  <li>두 개 이상의 애그리거트를 수정해야 한다면, 도메인 이벤트를 사용한다.</li>
</ul>

<h2 id="33-리포지터리와-애그리거트">3.3 리포지터리와 애그리거트</h2>
<ul>
  <li>애그리거트: 개념상 완전한 하나의 도메인 모델</li>
  <li>리포지터리: 애그리거트 영속성을 처리
    <ul>
      <li>save: 애그리거트 저장</li>
      <li>findById: ID로 애그리거트를 구함</li>
    </ul>
  </li>
</ul>

<h2 id="34-id를-이용한-애그리거트-참조">3.4 ID를 이용한 애그리거트 참조</h2>
<ul>
  <li>애그리거트도 다른 애그리거트를 참조한다.</li>
  <li>애그리거트 참조는 애그리거트 루트가 다른 애그리거트 루트를 참조한다는 뜻이다.</li>
</ul>

<p><br /></p>

<p><strong>필드 참조</strong></p>
<center><img src="/assets/images/posts/books/1/3_4_필드참조.png" alt="필드참조" width="80%" height="80%" /></center>

<p><strong>필드 참조 문제점</strong></p>
<ul>
  <li>편한 탐색 오용</li>
  <li>결합도 증가</li>
  <li>성능에 대한 고민</li>
  <li>확장 어려움</li>
</ul>

<p><br /></p>

<p><strong>ID를 이용한 참조</strong></p>
<center><img src="/assets/images/posts/books/1/3_4_ID참조.png" alt="ID참조" width="80%" height="80%" /></center>

<p><strong>ID 참조 장점</strong></p>
<ul>
  <li>모델의 복잡도를 낮춘다</li>
  <li>응집도 증가</li>
  <li>구현 난이도 감소</li>
  <li>확장 용이</li>
</ul>

<h3 id="341-id를-이용한-참조와-조회-성능">3.4.1 ID를 이용한 참조와 조회 성능</h3>

<p>ID를 이용한 조회는 <strong>N + 1 문제가 발생</strong>한다.<br />
해결방법은 아래와 같다.</p>
<ul>
  <li>조회 전용 쿼리를 만들어 사용한다.</li>
  <li>쿼리가 복잡하거나 특화된 기능을 사용해야 한다면 마이바티스와 같은 기술로 구현하는걸 고려한다.</li>
</ul>

<h2 id="35-애그리거트-간-집합-연관">3.5 애그리거트 간 집합 연관</h2>
<p>1-N, M-N 연관에 대해 살펴본다.</p>

<p><strong>1-N</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Category</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">products</span><span class="o">;</span> <span class="c1">//다른 애그리거트에 대한 1-N 연관</span>
<span class="o">}</span>
</code></pre></div></div>
<p>조회시 개념적으로 애거리거트 간에 1-N 연관이 있더라도 성능 문제 때문에 실제 구현에 반영하지 않는다. N-1로 연관지어 구현한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">CategoryId</span> <span class="n">categoryId</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductListService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="nf">getProductOfCategory</span><span class="o">(</span><span class="nc">Long</span> <span class="n">categoryId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">page</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Category</span> <span class="n">category</span> <span class="o">=</span> <span class="n">categoryRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">categoryId</span><span class="o">);</span>
        <span class="n">checkCategory</span><span class="o">(</span><span class="n">category</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">products</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">findByCategoryId</span><span class="o">(</span><span class="n">category</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">page</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">totalCount</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">countByCategoryId</span><span class="o">(</span><span class="n">category</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Page</span><span class="o">(</span><span class="n">page</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">totalCount</span><span class="o">,</span> <span class="n">products</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>M-N</strong><br />
M-N 연관은 개념적으로 양쪽 애그리거트에 컬렉션으로 연관을 만든다. 하지만 구현은 요구사항을 고려해서 결정한다. 개념적으로는 상품과 카테고리의 양방향 M-N 연관이 존재하지만 실제 구현에서는 상품에서 카테고리로의 단방향 M-N 연관만 적용하면 되는 것이다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">CategoryId</span><span class="o">&gt;</span> <span class="n">categoryIds</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>RDBMS에서 M-N 연관 구현</strong></p>
<center><img src="/assets/images/posts/books/1/3_5_RDBMS_M-N연관.png" alt="RDBMS_M-N연관" width="80%" height="80%" /></center>

<p><br /></p>

<p><strong>JPA를 이용하여 ID 참조를 이용한 M-N 단방향 연관 구현</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"product"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="nd">@EmbeddedId</span>
    <span class="kd">private</span> <span class="nc">ProductId</span> <span class="n">id</span><span class="o">;</span>
    
    <span class="nd">@ElementCollection</span>
    <span class="nd">@CollectionTable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"product_category"</span><span class="o">,</span>
        <span class="n">joinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"product_id"</span><span class="o">))</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">CategoryId</span><span class="o">&gt;</span> <span class="n">categoryIds</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="36-애그리거트를-팩토리로-사용하기">3.6 애그리거트를 팩토리로 사용하기</h2>
<ul>
  <li>애그리거트가 갖고 있는 데이터를 이용해서 다른 애그리거트를 생성해야 한다면 애그리거트에 팩토리 메서드를 구현하는 것을 고려한다.</li>
  <li>별도의 도메인 서비스나, 팩토리 클래스를 만들 수도 있다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Store</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Product</span> <span class="nf">createProduct</span> <span class="o">(</span><span class="nc">ProductId</span> <span class="n">newProductId</span><span class="o">,</span> <span class="o">...</span><span class="na">생략</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isBlocked</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">StoreBlockedException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Product</span><span class="o">(</span><span class="n">newProductId</span><span class="o">,</span> <span class="n">getId</span><span class="o">(),</span> <span class="o">...</span><span class="na">생략</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p><br />
<br />
<br /></p>

<h1 id="4-리포지터리와-모델-구현">4. 리포지터리와 모델 구현</h1>
<p>자세한 설명은 아래의 문서와 책을 읽는 것을 추천합니다. 👍</p>
<ul>
  <li><a href="https://product.kyobobook.co.kr/detail/S000001810495" target="_blank">도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지</a></li>
  <li><a href="http://www.yes24.com/Product/Goods/19040233" target="_blank">자바 ORM 표준 JPA 프로그래밍</a></li>
  <li><a href="https://spring.io/projects/spring-data-jpa" target="_blank">Spring Data JPA</a></li>
</ul>

<h2 id="41-jpa를-이용한-리포지터리-구현">4.1 JPA를 이용한 리포지터리 구현</h2>
<h3 id="411-모듈-위치">4.1.1 모듈 위치</h3>
<center><img src="/assets/images/posts/books/1/4_1_모듈위치.png" alt="모듈위치" width="80%" height="80%" /></center>

<h3 id="412-리포지터리-기본-기능-구현">4.1.2 리포지터리 기본 기능 구현</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="o">{</span>
    <span class="nc">Order</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">OrderNo</span> <span class="n">no</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JpaOrderRepository</span> <span class="kd">implements</span> <span class="nc">OrderRepository</span> <span class="o">{</span>
    <span class="nd">@PersistenceContext</span>
    <span class="kd">private</span> <span class="nc">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Order</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">OrderNo</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">entityManager</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="42-스프링-데이터-jpa를-이용한-리포지터리-구현">4.2 스프링 데이터 JPA를 이용한 리포지터리 구현</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"purchase_order"</span><span class="o">)</span>
<span class="nd">@Access</span><span class="o">(</span><span class="nc">AccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="nd">@EmbeddedId</span>
    <span class="kd">private</span> <span class="nc">OrderNo</span> <span class="n">number</span><span class="o">;</span>

    <span class="nd">@Version</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span>

    <span class="nd">@Embedded</span>
    <span class="kd">private</span> <span class="nc">Orderer</span> <span class="n">orderer</span><span class="o">;</span>

    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">,</span> <span class="nc">OrderNo</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">OrderNo</span> <span class="n">id</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">);</span>

    <span class="k">default</span> <span class="nc">OrderNo</span> <span class="nf">nextOrderNo</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">randomNo</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">900000</span><span class="o">)</span> <span class="o">+</span> <span class="mi">100000</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">number</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%tY%&lt;tm%&lt;td%&lt;tH-%d"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(),</span> <span class="n">randomNo</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">OrderNo</span><span class="o">(</span><span class="n">number</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CancelOrderService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">OrderRepository</span> <span class="n">orderRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">CancelPolicy</span> <span class="n">cancelPolicy</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CancelOrderService</span><span class="o">(</span><span class="nc">OrderRepository</span> <span class="n">orderRepository</span><span class="o">,</span> <span class="nc">CancelPolicy</span> <span class="n">cancelPolicy</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">orderRepository</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cancelPolicy</span> <span class="o">=</span> <span class="n">cancelPolicy</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cancel</span><span class="o">(</span><span class="nc">OrderNo</span> <span class="n">orderNo</span><span class="o">,</span> <span class="nc">Canceller</span> <span class="n">canceller</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">orderNo</span><span class="o">)</span>
                <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">NoOrderException</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">cancelPolicy</span><span class="o">.</span><span class="na">hasCancellationPermission</span><span class="o">(</span><span class="n">order</span><span class="o">,</span> <span class="n">canceller</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoCancellablePermission</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">order</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="43-매핑-구현">4.3 매핑 구현</h2>
<h3 id="431-엔티티와-밸류-기본-매핑-구현">4.3.1 엔티티와 밸류 기본 매핑 구현</h3>
<p>애그리거트와 JPA 매핑을 위한 기본 규칙</p>
<ul>
  <li>애그리거트 루트는 엔티티이므로 <code class="language-plaintext highlighter-rouge">@Entity</code>로 매핑 설정한다.</li>
</ul>

<p>한 테이블에 엔티티와 밸류 데이터가 같이 있다면</p>
<ul>
  <li>밸류는 <code class="language-plaintext highlighter-rouge">@Embeddable</code>로 매핑 설정한다.</li>
  <li>밸류 타입 프로퍼티는 <code class="language-plaintext highlighter-rouge">@Embedded</code>로 매핑 설정한다.</li>
  <li>매핑할 컬럼명 변경은 <code class="language-plaintext highlighter-rouge">@AttributeOverrides</code> 를 이용한다</li>
</ul>

<center><img src="/assets/images/posts/books/1/4_3_매핑구현.png" alt="매핑구현" width="80%" height="80%" /></center>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShippingInfo</span> <span class="o">{</span>
    <span class="nd">@Embedded</span>
    <span class="nd">@AttributeOverrides</span><span class="o">({</span>
            <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"zipCode"</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"shipping_zip_code"</span><span class="o">)),</span>
            <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"address1"</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"shipping_addr1"</span><span class="o">)),</span>
            <span class="nd">@AttributeOverride</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"address2"</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"shipping_addr2"</span><span class="o">))</span>
    <span class="o">})</span>
    <span class="kd">private</span> <span class="nc">Address</span> <span class="n">address</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"shipping_message"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>
    <span class="nd">@Embedded</span>
    <span class="kd">private</span> <span class="nc">Receiver</span> <span class="n">receiver</span><span class="o">;</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"purchase_order"</span><span class="o">)</span>
<span class="nd">@Access</span><span class="o">(</span><span class="nc">AccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Embedded</span>
    <span class="kd">private</span> <span class="nc">Orderer</span> <span class="n">orderer</span><span class="o">;</span>

    <span class="nd">@Embedded</span>
    <span class="kd">private</span> <span class="nc">ShippingInfo</span> <span class="n">shippingInfo</span><span class="o">;</span>
    <span class="o">...</span>
</code></pre></div></div>

<h3 id="432-기본-생성자">4.3.2 기본 생성자</h3>
<p>엔티티는 기본 생성자가 필요하다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nf">Receiver</span><span class="o">(){}</span>
</code></pre></div></div>

<h3 id="432-필드-접근-방식-사용">4.3.2 필드 접근 방식 사용</h3>
<p><code class="language-plaintext highlighter-rouge">@Access</code>를 이용해서 명시적으로 접근 방식을 지정하지 않으면 <code class="language-plaintext highlighter-rouge">@Id</code>나 <code class="language-plaintext highlighter-rouge">@EmbeddedId</code>의 위치에 따라 접근 방식을 결정한다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"purchase_order"</span><span class="o">)</span>
<span class="nd">@Access</span><span class="o">(</span><span class="nc">AccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="434-attributeconverter를-이용한-밸류-매핑-처리">4.3.4 AttributeConverter를 이용한 밸류 매핑 처리</h3>
<p><strong>두 개 이상의 프로퍼티를 가진 밸류 타입을 한 개 컬럼에 매핑</strong>하려면 <code class="language-plaintext highlighter-rouge">@Embeddable</code> 애너테이션으로는 처리할 수 없다. 이럴 때 사용할 수 있는 것이 <code class="language-plaintext highlighter-rouge">AttributeConverter</code>이다.</p>

<center><img src="/assets/images/posts/books/1/4_3_두개프러퍼컬럼매핑.png" alt="두개프러퍼컬럼매핑" width="100%" height="100%" /></center>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Converter</span><span class="o">(</span><span class="n">autoApply</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MoneyConverter</span> <span class="kd">implements</span> <span class="nc">AttributeConverter</span><span class="o">&lt;</span><span class="nc">Money</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span> 
    <span class="c1">// Money는 밸류 타입, Integer는 DB 타입</span>

    <span class="c1">// 밸류 타입을 DB 칼럼 값으로 변환</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">convertToDatabaseColumn</span><span class="o">(</span><span class="nc">Money</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">money</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">money</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// DB 칼럼 값을 밸류로 변환</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Money</span> <span class="nf">convertToEntityAttribute</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">Money</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @Converter(autoApply = true) 작성한 타입에 대해 자동 적용</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"total_amounts"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Money</span> <span class="n">totalAmounts</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @Converter(autoApply = false) 기본값, 직접 지정해야함</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>

    <span class="nd">@Convert</span><span class="o">(</span><span class="n">converter</span> <span class="o">=</span> <span class="nc">MoneyConverter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"total_amounts"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Money</span> <span class="n">totalAmounts</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="435-밸류-컬렉션-별도-테이블-매핑">4.3.5 밸류 컬렉션: 별도 테이블 매핑</h3>
<p>밸류 컬렉션을 별도 테이블로 매핑할때는 <code class="language-plaintext highlighter-rouge">@ElementCollection</code>과 <code class="language-plaintext highlighter-rouge">@CollectionTable</code>을 함께 사용한다.</p>

<center><img src="/assets/images/posts/books/1/4_3_밸류컬렉션테이블매핑.png" alt="밸류컬렉션테이블매핑" width="70%" height="70%" /></center>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"purchase_order"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="nd">@EmbeddedId</span>
    <span class="kd">private</span> <span class="nc">OrderNo</span> <span class="n">number</span><span class="o">;</span>

    <span class="nd">@ElementCollection</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@CollectionTable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"order_line"</span><span class="o">,</span> <span class="n">joinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"order_number"</span><span class="o">))</span>
    <span class="nd">@OrderColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"line_idx"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span><span class="o">;</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderLine</span> <span class="o">{</span>
    <span class="nd">@Embedded</span>
    <span class="kd">private</span> <span class="nc">ProductId</span> <span class="n">productId</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"price"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Money</span> <span class="n">price</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"quantity"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"amounts"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Money</span> <span class="n">amounts</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="436-밸류-컬렉션-한-개-컬럼-매핑">4.3.6 밸류 컬렉션: 한 개 컬럼 매핑</h3>
<p>한 개 컬럼에 콤마로 구분해서 저장할 때 사용. <code class="language-plaintext highlighter-rouge">AttributeConverter</code>를 이용한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmailSet</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Email</span><span class="o">&gt;</span> <span class="n">emails</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">EmailSet</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Email</span><span class="o">&gt;</span> <span class="n">emails</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">emails</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">emails</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Email</span><span class="o">&gt;</span> <span class="nf">getEmails</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableSet</span><span class="o">(</span><span class="n">emails</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmailSetConverter</span> <span class="kd">implements</span> <span class="nc">AttributeConverter</span><span class="o">&lt;</span><span class="nc">EmailSet</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">convertToDatabaseColumn</span><span class="o">(</span><span class="nc">EmailSet</span> <span class="n">attribute</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">attribute</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">attribute</span><span class="o">.</span><span class="na">getEmails</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">email</span> <span class="o">-&gt;</span> <span class="n">email</span><span class="o">.</span><span class="na">getAddress</span><span class="o">())</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">","</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">EmailSet</span> <span class="nf">convertToEntityAttribute</span><span class="o">(</span><span class="nc">String</span> <span class="n">dbData</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dbData</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">emails</span> <span class="o">=</span> <span class="n">dbData</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Email</span><span class="o">&gt;</span> <span class="n">emailSet</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">emails</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Email</span><span class="o">(</span><span class="n">value</span><span class="o">))</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toSet</span><span class="o">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">EmailSet</span><span class="o">(</span><span class="n">emailSet</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="437-밸류를-이용한-id-매핑">4.3.7 밸류를 이용한 ID 매핑</h3>
<p>JPA에서 식별자 타입은 <code class="language-plaintext highlighter-rouge">Serializable</code> 타입이어야 하므로 <code class="language-plaintext highlighter-rouge">Serializable</code> 인터페이스를 상속받아야 한다. 밸류 타입으로 식별자를 구현할 때 얻을 수 있는 장점은 식별자에 기능을 추가할 수 있다는 점이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"purchase_order"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="nd">@EmbeddedId</span>
    <span class="kd">private</span> <span class="nc">OrderNo</span> <span class="n">number</span><span class="o">;</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Embeddable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderNo</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"order_number"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">number</span><span class="o">;</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="438-별도-테이블에-저장하는-밸류-매핑">4.3.8 별도 테이블에 저장하는 밸류 매핑</h3>
<p>루트 엔티티 외에 또 다른 엔티티가 있다면 진짜 엔티티인지 의심해 봐야한다. 단지 별도 테이블에 데이터를 저장 한다고 해서 엔티티인 것은 아니다.</p>

<p>예를 들어 게시글 데이터를 <code class="language-plaintext highlighter-rouge">ARTICLE</code> 테이블과 <code class="language-plaintext highlighter-rouge">ARTICLE_CONTENT</code> 테이블로 나눠서 저장한다고 하자.</p>

<p><strong>엔티티로 매핑 예 (잘못 됨)</strong></p>
<center><img src="/assets/images/posts/books/1/4_3_밸류매핑잘못.png" alt="밸류매핑잘못" width="80%" height="80%" /></center>
<p><code class="language-plaintext highlighter-rouge">ARTICLE_CONTENT</code>에 ID는 식별자이긴 하지만 이는 <code class="language-plaintext highlighter-rouge">ARTICLE</code> 테이블과 연결을 위함이지 <code class="language-plaintext highlighter-rouge">ARTICLE_CONTENT</code>를 위한 별도 식별자가 필요해서가 아니다.</p>

<p><br /></p>

<p><strong>별도 테이블로 매핑</strong></p>
<center><img src="/assets/images/posts/books/1/4_3_밸류매핑별도테이블.png" alt="밸류매핑별도테이블" width="80%" height="80%" /></center>
<p><code class="language-plaintext highlighter-rouge">ARTICLE_CONTENT</code>을 밸류로 만들고 @Embeddable로 매핑한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"article"</span><span class="o">)</span>
<span class="nd">@SecondaryTable</span><span class="o">(</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">"article_content"</span><span class="o">,</span>
        <span class="n">pkJoinColumns</span> <span class="o">=</span> <span class="nd">@PrimaryKeyJoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Article</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="nd">@AttributeOverrides</span><span class="o">({</span>
            <span class="nd">@AttributeOverride</span><span class="o">(</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s">"content"</span><span class="o">,</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">table</span> <span class="o">=</span> <span class="s">"article_content"</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"content"</span><span class="o">)),</span>
            <span class="nd">@AttributeOverride</span><span class="o">(</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s">"contentType"</span><span class="o">,</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="o">(</span><span class="n">table</span> <span class="o">=</span> <span class="s">"article_content"</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"content_type"</span><span class="o">))</span>
    <span class="o">})</span>
    <span class="nd">@Embedded</span>
    <span class="kd">private</span> <span class="nc">ArticleContent</span> <span class="n">content</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>밸류 매핑을 별도 테이블로 저장 하려면 <code class="language-plaintext highlighter-rouge">@SecondaryTable</code>과 <code class="language-plaintext highlighter-rouge">@AttributeOverride</code>을 사용한다.
하지만 <code class="language-plaintext highlighter-rouge">@SecondaryTable</code>은 <code class="language-plaintext highlighter-rouge">jpa.find("id");</code>(조회)를 실행할 때 두 테이블을 조인해서 가져온다. 게시글 목록 같은 화면은 <code class="language-plaintext highlighter-rouge">ARTICLE</code>의 데이터만 필요하지 <code class="language-plaintext highlighter-rouge">ARTICLE_CONTENT</code>는 필요없다.</p>

<p>이를 해결하기 위해 <code class="language-plaintext highlighter-rouge">ARTICLE_CONTENT</code>을 엔티티로 매핑하고 <code class="language-plaintext highlighter-rouge">ARTICLE</code>에서 <code class="language-plaintext highlighter-rouge">ARTICLE_CONTENT</code>을 지연로딩 할 수도 있다. 하지만 이는 밸류 모델을 엔티티로 만드는 것이므로 좋은 방법은 아니다. 대신 조회 전용 기능을 사용하는 것이 좋다.</p>

<h3 id="439-밸류-컬렉션을-entity로-매핑하기">4.3.9 밸류 컬렉션을 @Entity로 매핑하기</h3>
<p><code class="language-plaintext highlighter-rouge">@OneToMany</code> 사용하여 연관관계를 맺는다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"product"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">cascade</span> <span class="o">=</span> <span class="o">{</span><span class="nc">CascadeType</span><span class="o">.</span><span class="na">PERSIST</span><span class="o">,</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">REMOVE</span><span class="o">},</span>
            <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"product_id"</span><span class="o">)</span>
    <span class="nd">@OrderColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"list_idx"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Image</span><span class="o">&gt;</span> <span class="n">images</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
</code></pre></div></div>

<p><br /></p>

<p><code class="language-plaintext highlighter-rouge">@Inheritance</code>를 이용하여 엔티티 상속도 가능하다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">InheritanceType</span><span class="o">.</span><span class="na">SINGLE_TABLE</span><span class="o">)</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"image_type"</span><span class="o">)</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"image"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Image</span> <span class="o">{</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"II"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InternalImage</span> <span class="kd">extends</span> <span class="nc">Image</span> <span class="o">{</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"EI"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExternalImage</span> <span class="kd">extends</span> <span class="nc">Image</span> <span class="o">{</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
</code></pre></div></div>

<h3 id="4310-id-참조와-조인-테이블을-이용한-단방향-m-n-매핑">4.3.10 ID 참조와 조인 테이블을 이용한 단방향 M-N 매핑</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"product"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
    <span class="nd">@ElementCollection</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@CollectionTable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"product_category"</span><span class="o">,</span>
            <span class="n">joinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"product_id"</span><span class="o">))</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">CategoryId</span><span class="o">&gt;</span> <span class="n">categoryIds</span><span class="o">;</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="44-애그리거트-로딩-전략">4.4 애그리거트 로딩 전략</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @Embeddable 컬렉션에 대한 즉시 로딩 설정</span>
<span class="nd">@ElementCollection</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>

<span class="c1">// @Entity 컬렉션에 대한 지연 로딩 설정</span>
<span class="nd">@OneToMany</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
</code></pre></div></div>
<ul>
  <li>즉시 로딩: 에그리거트 루트를 구할 때 연관된 구성 요소를 DB에서 함께 읽어온다.</li>
  <li>지연 로딩: 실제 컬렉션에 접근할 때 DB에서 조회한다.</li>
</ul>

<h2 id="45-애그리거트-영속성-전파">4.5 애그리거트 영속성 전파</h2>
<p>애그리거트가 완전한 상태여야 한다는 것은 <strong>애그리거트 루트를 조회할 때뿐만 아니라 저장하고 삭제할 때도 하나로 처리해야 함을 의미</strong>한다.</p>
<ul>
  <li><strong>저장 메서드</strong>는 애그리거트 루트만 저장하면 안되고 <strong>애그리거트에 속한 모든 객체를 저장</strong>해야 한다.</li>
  <li><strong>삭제 메서드</strong>는 애그리거트 루트뿌만 아니라 <strong>애그리거트에 속한 모든 객체를 삭제</strong>해야 한다.</li>
  <li><code class="language-plaintext highlighter-rouge">@Embeddable</code> 매핑 타입은 함께 저장되고 삭제 되므로 추가 설정이 필요없다.</li>
  <li><code class="language-plaintext highlighter-rouge">@Entity</code> 타입에 대한 매핑은 <code class="language-plaintext highlighter-rouge">cascade</code> 속성을 사용한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@OneToMany</span><span class="o">(</span><span class="n">cascade</span> <span class="o">=</span> <span class="o">{</span><span class="nc">CascadeType</span><span class="o">.</span><span class="na">PERSIST</span><span class="o">,</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">REMOVE</span><span class="o">})</span>
</code></pre></div></div>

<h2 id="46-식별자-생성-기능">4.6 식별자 생성 기능</h2>
<p>식별자는 크게 세 가지 방식 중 하나로 생성한다.</p>
<ul>
  <li>사용자가 직접 생성</li>
  <li>도메인 로직으로 생성</li>
  <li>DB를 이용한 일련번호 사용</li>
</ul>

<h2 id="47-도메인-구현과-dip">4.7 도메인 구현과 DIP</h2>
<p>JPA의 @Entity나 @Table, extends Repository 인터페이스는 DIP 원칙을 어기고 있지만 개발 편의성과 실용성을 가지고, 복잡도를 높이지 않으면서 기술에 따른 구현 제약이 낮다면 합리적으로 선택하여 사용할 수 있다.</p>

<p><br />
<br />
<br /></p>

<h1 id="5-스프링-데이터-jpa를-이용한-조회-기능">5. 스프링 데이터 JPA를 이용한 조회 기능</h1>

<h2 id="51-시작에-앞서">5.1 시작에 앞서</h2>
<h2 id="52-검색을-위한-스펙">5.2 검색을 위한 스펙</h2>
<p>조회를 위해 다양한 검색 조건을 조합해야 할 때가 있다. 이 때 사용할 수 있는 것이 스펙(<a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#specifications" target="_blank">Specification</a>)이다.</p>

<h2 id="53-스프링-데이터-jpa를-이용한-스펙-구현">5.3 스프링 데이터 JPA를 이용한 스펙 구현</h2>

<p><strong>스프링 데이터 JPA가 제공하는 Specification 인터페이스</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Specification</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nc">Predicate</span> <span class="nf">toPredicate</span><span class="o">(</span><span class="nc">Root</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span> <span class="nc">CriteriaQuery</span><span class="o">&lt;?&gt;</span> <span class="n">query</span><span class="o">,</span> <span class="nc">CriteriaBuilder</span> <span class="n">builder</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>레포지토리 인터페이스 상속</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomerRepository</span> <span class="kd">extends</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;,</span> <span class="nc">JpaSpecificationExecutor</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Specification</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="n">spec</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Specification</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="n">spec</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">(</span><span class="nc">Specification</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="n">spec</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>스펙 생성 기능을 별도 클래스로 구현</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerSpecs</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Specification</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">isLongTermCustomer</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">builder</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">LocalDate</span> <span class="n">date</span> <span class="o">=</span> <span class="nc">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">minusYears</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">lessThan</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Customer_</span><span class="o">.</span><span class="na">createdAt</span><span class="o">),</span> <span class="n">date</span><span class="o">);</span>
    <span class="o">};</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Specification</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">hasSalesOfMoreThan</span><span class="o">(</span><span class="nc">MonetaryAmount</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">builder</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// build query here</span>
    <span class="o">};</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="54-리포지터리dao에서-스펙-사용하기">5.4 리포지터리/DAO에서 스펙 사용하기</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="n">customers</span> <span class="o">=</span> <span class="n">customerRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">isLongTermCustomer</span><span class="o">());</span>
</code></pre></div></div>

<h2 id="55-스펙-조합">5.5 스펙 조합</h2>
<p>스펙 인터페이스는 <code class="language-plaintext highlighter-rouge">and</code>와 <code class="language-plaintext highlighter-rouge">or</code> 등 조합 메서드를 제공한다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MonetaryAmount</span> <span class="n">amount</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MonetaryAmount</span><span class="o">(</span><span class="mf">200.0</span><span class="o">,</span> <span class="nc">Currencies</span><span class="o">.</span><span class="na">DOLLAR</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="n">customers</span> <span class="o">=</span> <span class="n">customerRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span>
  <span class="n">isLongTermCustomer</span><span class="o">().</span><span class="na">or</span><span class="o">(</span><span class="n">hasSalesOfMoreThan</span><span class="o">(</span><span class="n">amount</span><span class="o">)));</span>
</code></pre></div></div>

<p><br /></p>

<p><code class="language-plaintext highlighter-rouge">null</code> 가능성이 있는 스펙 객체의 조합은 <code class="language-plaintext highlighter-rouge">where</code>를 사용한다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Specification</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="n">spec</span> <span class="o">=</span> <span class="nc">Specification</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">createNullableSpec</span><span class="o">()).</span><span class="na">and</span><span class="o">(</span><span class="n">createOtherSpec</span><span class="o">());</span>
</code></pre></div></div>

<h2 id="56-정렬-지정하기">5.6 정렬 지정하기</h2>
<p>스프링 데이터 JPA는 두 가지 방법을 사용해서 정렬을 지정할 수 있다.</p>
<ul>
  <li>메서드 이름에 OrderBy를 사용해서 정렬 기준 지정</li>
  <li>Sort를 인자로 전달</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderSummaryDao</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">OrderSummary</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// OrderBy</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderSummary</span><span class="o">&gt;</span> <span class="nf">findByOrdererIdOrderByNumberDesc</span><span class="o">(</span><span class="nc">String</span> <span class="n">ordererId</span><span class="o">);</span>

    <span class="c1">// Sort</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderSummary</span><span class="o">&gt;</span> <span class="nf">findByOrdererId</span><span class="o">(</span><span class="nc">String</span> <span class="n">ordererId</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"number"</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderSummary</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">orderSummaryDao</span><span class="o">.</span><span class="na">findByOrdererId</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">sort</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="57-페이징-처리하기">5.7 페이징 처리하기</h2>
<p>스프링 데이터 JPA는 페이징 처리를 위해 <code class="language-plaintext highlighter-rouge">Pageable</code> 타입을 이용한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberDataDao</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">MemberData</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MemberData</span><span class="o">&gt;</span> <span class="nf">findByNameLike</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">MemberData</span><span class="o">&gt;</span> <span class="nf">findByBlocked</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">blocked</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1은 페이지 번호, 0부터 시작한다.  10은 개수</span>
<span class="c1">// Sort 사용 가능</span>
<span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"name"</span><span class="o">);</span>
<span class="nc">PageRequest</span> <span class="n">pageReq</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="n">sort</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">MemberData</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">memberDataDao</span><span class="o">.</span><span class="na">findByNameLike</span><span class="o">(</span><span class="s">"이름%"</span><span class="o">,</span> <span class="n">pageReq</span><span class="o">);</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>Page 리턴 타입</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">PageRequest</span> <span class="n">pageReq</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
<span class="nc">Page</span><span class="o">&lt;</span><span class="nc">MemberData</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">memberDataDao</span><span class="o">.</span><span class="na">findByBlocked</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">pageReq</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">MemberData</span><span class="o">&gt;</span> <span class="n">content</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span> <span class="c1">// 조회 결과 목록</span>
<span class="kt">long</span> <span class="n">totalElements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">();</span> <span class="c1">// 조건에 해당하는 전체 개수</span>
<span class="kt">int</span> <span class="n">totalPages</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">();</span> <span class="c1">// 전체 페이지 번호</span>
<span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getNumber</span><span class="o">();</span> <span class="c1">// 현재 페이지 번호</span>
<span class="kt">int</span> <span class="n">numberOfElements</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getNumberOfElements</span><span class="o">()</span> <span class="c1">// 조회 결과 개수</span>
<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getSize</span><span class="o">();</span> <span class="c1">// 페이지 크기</span>
</code></pre></div></div>

<p>Page 리턴 타입은 COUNT 쿼리를 실행하므로 List만 필요한 경우 리턴 타입을 List로 한다.</p>

<h2 id="58-스펙-조합을-위한-스펙-빌더-클래스">5.8 스펙 조합을 위한 스펙 빌더 클래스</h2>
<p>스펙을 조합할 때 스펙 빌더를 만들어 사용할 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Specification</span><span class="o">&lt;</span><span class="nc">MemberData</span><span class="o">&gt;</span> <span class="n">spec</span> <span class="o">=</span> <span class="nc">SpecBuilder</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="nc">MemberData</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">ifTrue</span><span class="o">(</span><span class="n">searchRequest</span><span class="o">.</span><span class="na">isOnlyNotBlocked</span><span class="o">(),</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">MemberDataSpecs</span><span class="o">.</span><span class="na">nonBlocked</span><span class="o">())</span>
                <span class="o">.</span><span class="na">ifHasText</span><span class="o">(</span><span class="n">searchRequest</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="nc">MemberDataSpecs</span><span class="o">.</span><span class="na">nameLike</span><span class="o">(</span><span class="n">searchRequest</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">toSpec</span><span class="o">();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">MemberData</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">memberDataDao</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">spec</span><span class="o">,</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">5</span><span class="o">));</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpecBuilder</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Builder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">builder</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Builder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Specification</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">specs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="kd">public</span> <span class="nc">Builder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">and</span><span class="o">(</span><span class="nc">Specification</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">spec</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">specs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">spec</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Builder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">ifHasText</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">,</span>
                                    <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Specification</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">specSupplier</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">str</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">specs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">specSupplier</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">str</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Builder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">ifTrue</span><span class="o">(</span><span class="nc">Boolean</span> <span class="n">cond</span><span class="o">,</span>
                                 <span class="nc">Supplier</span><span class="o">&lt;</span><span class="nc">Specification</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">specSupplier</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cond</span><span class="o">.</span><span class="na">booleanValue</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">specs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">specSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Specification</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">toSpec</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Specification</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">spec</span> <span class="o">=</span> <span class="nc">Specification</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Specification</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">:</span> <span class="n">specs</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">spec</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="59-동적-인스턴스-생성">5.9 동적 인스턴스 생성</h2>
<p>JPQL의 new 키워드를 통해 객체를 동적으로 생성할 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderSummaryDao</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">OrderSummary</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">"""    
            select new com.myshop.order.query.dto.OrderView(
                o.number, o.state, m.name, m.id, p.name
            )
            from Order o join o.orderLines ol, Member m, Product p
            where o.orderer.memberId.id = :ordererId
            and o.orderer.memberId.id = m.id
            and index(ol) = 0
            and ol.productId.id = p.id
            order by o.number.number desc
            """</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderView</span><span class="o">&gt;</span> <span class="nf">findOrderView</span><span class="o">(</span><span class="nc">String</span> <span class="n">ordererId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="510-하이버네이트-subselect-사용">5.10 하이버네이트 @Subselect 사용</h2>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@Subselect</code>는 쿼리 결과를 <code class="language-plaintext highlighter-rouge">@Entity</code>로 매핑할 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">@Immutable</code>, <code class="language-plaintext highlighter-rouge">@Subselect</code>, <code class="language-plaintext highlighter-rouge">@Synchronize</code> 와 같이 사용한다.</li>
  <li>뷰를 수정할 수 없듯 <code class="language-plaintext highlighter-rouge">@Subselect</code>로 조회한 <code class="language-plaintext highlighter-rouge">@Entity</code> 역시 수정할 수 없다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Immutable</span>
<span class="nd">@Subselect</span><span class="o">(</span>
        <span class="s">"""
        select o.order_number as number,
        o.version,
        o.orderer_id,
        o.orderer_name,
        o.total_amounts,
        o.receiver_name,
        o.state,
        o.order_date,
        p.product_id,
        p.name as product_name
        from purchase_order o inner join order_line ol
            on o.order_number = ol.order_number
            cross join product p
        where
        ol.line_idx = 0
        and ol.product_id = p.product_id"""</span>
<span class="o">)</span>
<span class="nd">@Synchronize</span><span class="o">({</span><span class="s">"purchase_order"</span><span class="o">,</span> <span class="s">"order_line"</span><span class="o">,</span> <span class="s">"product"</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderSummary</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">number</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"orderer_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">ordererId</span><span class="o">;</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
    <span class="kd">protected</span> <span class="nf">OrderSummary</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br />
<br />
<br /></p>

<h1 id="6-응용-서비스와-표현-영역">6. 응용 서비스와 표현 영역</h1>

<h2 id="61-표현-영역과-응용-영역">6.1 표현 영역과 응용 영역</h2>
<center><img src="/assets/images/posts/books/1/6_1_표현영역과응용영역.png" alt="표현영역과응용영역.png" width="80%" height="80%" /></center>

<p><strong>표현 영역</strong></p>
<ul>
  <li>표현 영역은 사용자의 요청을 해석한다.</li>
  <li>사용자가 실행하고 싶은 기능을 판별하고 그 기능을 제공하는 응용 서비스를 실행한다.</li>
  <li>응용 서비스가 요구하는 형식으로 사용자 요청을 변환한다.</li>
  <li>응용 서비스의 실행 결과를 사용자에게 알맞은 형식으로 응답한다.</li>
</ul>

<p><strong>응용 영역</strong></p>
<ul>
  <li>실제 사용자가 원하는 기능을 제공한다.</li>
  <li>응용 서비스는 표현 영역에 의존하지 않는다.</li>
</ul>

<h2 id="62-응용-서비스의-역할">6.2 응용 서비스의 역할</h2>
<ul>
  <li>사용자(표현 영역)가 요청한 기능을 실행한다.</li>
  <li>도메인 객체를 사용해서 요청을 처리한다.</li>
  <li>도메인 객체 간의 흐름을 제어한다.</li>
  <li>트랜잭션 처리를 담당한다.</li>
  <li>접근 제어와 이벤트 처리를 한다.</li>
</ul>

<h3 id="621-도메인-로직-넣지-않기">6.2.1 도메인 로직 넣지 않기</h3>
<p>도메인 로직은 도메인 영역에 위치하고, 응용 서비스는 도메인 로직을 구현하지 않는다.</p>

<p><strong>이유</strong></p>
<ul>
  <li>코드의 응집성이 떨어진다.</li>
  <li>여러 응용 서비스에서 동일한 도메인 로직을 구현할 가능성이 높아진다.</li>
  <li>결과적으로 코드 변경을 어렵게 만든다.</li>
</ul>

<h2 id="63-응용-서비스의-구현">6.3 응용 서비스의 구현</h2>
<p>응용 서비스는 표현 영역과 도메인 영역을 연결하는 매개체 역할을 한다.(파사드 facade)</p>

<h3 id="631-응용-서비스의-크기">6.3.1 응용 서비스의 크기</h3>
<p>응용 서비스의 구현 방법은 크게 두 가지가 있다.</p>
<ul>
  <li>한 응용 서비스 클래스에 회원 도메인 모든 기능 구현하기</li>
  <li><strong>구분되는 기능별로 응용 서비스 클래스를 따로 구현하기</strong>(추천) 👍</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 각 응용 서비스에서 공통되는 로직을 별도 클래스로 구현</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MemberServiceHelper</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Member</span> <span class="nf">findExistingMember</span><span class="o">(</span><span class="nc">MemberRepository</span> <span class="n">repo</span><span class="o">,</span> <span class="nc">String</span> <span class="n">memberId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">memberId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoMemberException</span><span class="o">(</span><span class="n">memberId</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 공통 로직을 제공하는 메서드를 응용 서비스에서 사용</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">com</span><span class="o">.</span><span class="na">myshop</span><span class="o">.</span><span class="na">member</span><span class="o">.</span><span class="na">application</span><span class="o">.</span><span class="na">MemberServiceHelper</span><span class="o">.*;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChangePasswordService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">changePassword</span><span class="o">(</span><span class="nc">String</span> <span class="n">memberId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">curPw</span><span class="o">,</span> <span class="nc">String</span> <span class="n">newPw</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">findExistingMember</span><span class="o">(</span><span class="n">memberRepository</span><span class="o">,</span> <span class="n">memberId</span><span class="o">);</span>
        <span class="n">member</span><span class="o">.</span><span class="na">changePassword</span><span class="o">(</span><span class="n">curPw</span><span class="o">,</span> <span class="n">newPw</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="632-응용-서비스의-인터페이스와-클래스">6.3.2 응용 서비스의 인터페이스와 클래스</h3>
<p>인터페이스가 명확하게 필요하지 않다면 응용 서비스의 인터페이스 작성은 좋은 선택이 아니다. 소스 파일만 많아지고 간접 참조가 증가해서 전체 구조가 복잡해진다.</p>

<p><strong>인터페이스가 필요한 상황</strong></p>
<ul>
  <li>구현 클래스가 여러개인 경우</li>
</ul>

<h3 id="633-메서드-파라미터와-값-리턴">6.3.3 메서드 파라미터와 값 리턴</h3>
<ul>
  <li>도메인을 이용해 기능을 실행하는 데 필요한 값을 파라미터로 전달받아야 한다.</li>
  <li>각 값을 개별 파라미터로 전달받을 수도 있고 <strong>DTO를 만들어 전달</strong>받을 수도 있다.</li>
  <li>응용 서비스의 결과를 표현 영역에서 사용해야 한다면, 응용 서비스의 결과로 필요한 데이터를 리턴한다.</li>
  <li><strong>애그리거트 자체를 리턴하는 것은 응집도를 낮추어 비추천</strong>한다.</li>
</ul>

<h3 id="634-표현-영역에-의존하지-않기">6.3.4 표현 영역에 의존하지 않기</h3>
<p>표현 영역에 해당하는 HttpServletRequest, HttpSession 등을 응용 서비스에에 파라미터로 전달하면 안 된다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">ChangePasswordService</span> <span class="n">changePasswordService</span><span class="o">;</span>

<span class="nd">@PostMapping</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">sumbit</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 응용 서비스가 표현 영역을 의존하면 안된다.</span>
    <span class="n">changePasswordService</span><span class="o">.</span><span class="na">changePassword</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="635-트랜잭션-처리">6.3.5 트랜잭션 처리</h3>
<p>스프링과 같은 프레임워크가 제공하는 트랜잭션 관리 기능을 이용한다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span>
</code></pre></div></div>

<h2 id="64-표현-영역">6.4 표현 영역</h2>
<ul>
  <li>사용자가 시스템을 사용할 수 있는 흐름(화면)을 제공하고 제어한다.</li>
  <li>사용자의 요청을 알맞은 응용 서비스에 전달하고 결과를 사용자에게 제공한다.</li>
  <li>사용자의 세션을 관리한다.</li>
</ul>
<center><img src="/assets/images/posts/books/1/6_2_표현영역사용자흐름.png" alt="표현영역사용자흐름" width="60%" height="60%" /></center>

<h2 id="65-값-검증">6.5 값 검증</h2>
<p>값 검증은 표현 영역과 응용 서비스 두 곳에서 모두 수행할 수 있다. <strong>원칙적으로는 응용 서비스에서 처리</strong>한다.</p>

<p>응용 서비스를 사용하는 표현 영역의 코드가 한 곳이면 구현의 편리함을 위해 다음과 같이 역할을 나누어 검증을 수행할 수도 있다.</p>
<ul>
  <li>표현 영역: 필수 값, 값의 형식, 범위 등을 검증한다.</li>
  <li>응용 서비스: 데이터의 존재 유무와 같은 논리적 오류를 검증한다.</li>
</ul>

<h2 id="66-권한-검사">6.6 권한 검사</h2>
<p>다음 세 곳에서 권한 검사를 수행할 수 있다.</p>
<ul>
  <li>표현 영역
    <ul>
      <li>서블릿 필터</li>
    </ul>
  </li>
  <li>응용 서비스
    <ul>
      <li>AOP</li>
    </ul>
  </li>
  <li>도메인
    <ul>
      <li>직접 로직 구현</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 스프링 시큐리티 활용</span>
<span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasRole('ADMIN')"</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="67-조회-전용-기능과-응용-서비스">6.7 조회 전용 기능과 응용 서비스</h2>
<p>응용 서비스가 사용자 요청 기능을 실행하는 데 별다른 기여를 하지 못한다면 굳이 서비스를 만들지 않아도 된다.</p>

<p><img src="/assets/images/posts/books/1/6_4_응용서비스생략.png" alt="응용서비스생략" width="80%" height="80%" /></p>

<p><br />
<br />
<br /></p>

<h1 id="7-도메인-서비스">7. 도메인 서비스</h1>
<h2 id="71-여러-애그리거트가-필요한-기능">7.1 여러 애그리거트가 필요한 기능</h2>
<p>한 애그리거트에 넣기 애매한, 여러 애그리거트가 필요한 기능이라면 별도 도메인 서비스로 구현한다.</p>

<h2 id="72-도메인-서비스">7.2 도메인 서비스</h2>
<p>도메인 서비스는 도메인 영역에 위치한 도메인 로직을 표현할 때 사용한다. 주로 다음 상황에서 도메인 서비스를 사용한다.</p>
<ul>
  <li>계산 로직: 여러 애그리거트가 필요한 계산로직이나, 한 애그리거트에 넣기에는 다소 복잡한 계산 로직</li>
  <li>외부 시스템 연동이 필요한 도메인 로직: 구현하기 위해 타 시스템을 사용해야 하는 도메인 로직</li>
</ul>

<h3 id="721-계산-로직과-도메인-서비스">7.2.1 계산 로직과 도메인 서비스</h3>

<p><strong>도메인 서비스를 사용하는 주체</strong></p>
<ul>
  <li>애그리거트</li>
  <li>응용 서비스</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 애그리거트가 사용</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderService</span> <span class="o">{</span>
    <span class="c1">// 도메인 서비스</span>
    <span class="kd">private</span> <span class="nc">DiscountCalculationService</span> <span class="n">discountCalculationService</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Order</span> <span class="nf">createOrder</span><span class="o">(</span><span class="nc">OrderNo</span> <span class="n">orderNo</span><span class="o">,</span> <span class="nc">OrderRequest</span> <span class="n">orderReq</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">findMember</span><span class="o">(</span><span class="n">orderReq</span><span class="o">.</span><span class="na">getOrdererId</span><span class="o">());</span>
        <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">(</span><span class="n">orderNo</span><span class="o">,</span> <span class="o">...</span><span class="na">생략</span><span class="o">);</span>
        <span class="c1">// 애그리거트 객체에 도메인 서비스 전달</span>
        <span class="n">order</span><span class="o">.</span><span class="na">calculateAmounts</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">discountCalculationService</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getGrade</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 응용 서비스가 사용</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferService</span> <span class="o">{</span> <span class="c1">// 도메인 서비스</span>

    <span class="c1">// 도메인 서비스의 기능을 실행할 때 애그리거트를 전달</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="nc">Account</span> <span class="n">fromAcc</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">toAcc</span><span class="o">,</span> <span class="nc">Money</span> <span class="n">amounts</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">fromAcc</span><span class="o">.</span><span class="na">withdraw</span><span class="o">(</span><span class="n">amounts</span><span class="o">);</span>
        <span class="n">toAcc</span><span class="o">.</span><span class="na">credit</span><span class="o">(</span><span class="n">amounts</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>특정 기능이 응용 서비스인지 도메인 서비스인지 확인하는 방법</strong></p>

<p>아래의 행위가 일어나면 도메인 서비스</p>
<ul>
  <li>애그리거트의 상태를 변경</li>
  <li>애그리거트의 상태 값을 계산</li>
</ul>

<h3 id="722-외부-시스템-연동과-도메인-서비스">7.2.2 외부 시스템 연동과 도메인 서비스</h3>
<p>시스템 간 연동은 HTTP API 호출로 이루어질 수 있지만, 도메인 입장에서는 도메인 로직으로 볼 수 있다. <strong>도메인 관점에서 인터페이스를 작성</strong>한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 도메인 서비스</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SurveyPermissionChecker</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">hasUserCreationPermission</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//응용 서비스는 도메인 서비스를 이용</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreateSurveyService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">SurveyPermissionChecker</span> <span class="n">surveyPermissionChecker</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">createSurvey</span><span class="o">(</span><span class="nc">CreateSurveyRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">validate</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>

        <span class="c1">// 도메인 서비스를 이용해서 외부 시스템 연동을 표현</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">surveyPermissionChecker</span><span class="o">.</span><span class="na">hasUserCreationPermission</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getRequestorId</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoPermissionException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">SurveyPermissionChecker</code> 인터페이스를 구현한 클래스는 인프라스트럭처 영역에 위치한다.</p>

<h3 id="723-도메인-서비스의-패키지-위치">7.2.3 도메인 서비스의 패키지 위치</h3>
<center><img src="/assets/images/posts/books/1/7_2_도메인서비스위치.png" alt="도메인서비스위치" width="80%" height="80%" /></center>

<p><br /></p>

<p>도메인 서비스의 개수가 많거나 명시적으로 구분하고 싶다면 아래와 같이 하위 패키지로 구분한다.</p>
<ul>
  <li>domain
    <ul>
      <li>domain.model</li>
      <li>domain.service</li>
      <li>domain.repository</li>
    </ul>
  </li>
</ul>

<h3 id="724-도메인-서비스의-인터페이스와-클래스">7.2.4 도메인 서비스의 인터페이스와 클래스</h3>
<p>도메인 서비스의 로직이 고정되어 있지 않은 경우 <strong>도메인 서비스 자체를 인터페이스로 구현</strong>하고 이를 구현한 클래스를 둘 수도 있다.</p>

<center><img src="/assets/images/posts/books/1/7_2_도메인서비스인터페이스.png" alt="도메인서비스인터페이스" width="80%" height="80%" /></center>

<p><br />
<br />
<br /></p>

<h1 id="8-애그리거트-트랜잭션-관리">8. 애그리거트 트랜잭션 관리</h1>

<h2 id="81-애그리거트와-트랜잭션">8.1 애그리거트와 트랜잭션</h2>
<center><img src="/assets/images/posts/books/1/8_1_트랜잭션.png" alt="트랜잭션" width="60%" height="60%" /></center>

<p>트랜잭션 처리 방식</p>
<ul>
  <li>선점 잠금 (Pessimistic Lock, 비관적 잠금)</li>
  <li>비선점 잠금 (Optimistic Lock, 낙관적 잠금)</li>
</ul>

<h2 id="82-선점-잠금">8.2 선점 잠금</h2>
<center><img src="/assets/images/posts/books/1/8_2_선점잠금.png" alt="선점잠금" width="60%" height="60%" /></center>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// JPA</span>
<span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">orderNo</span><span class="o">,</span> <span class="nc">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">);</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 스프링 데이터 JPA</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberREpository</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">MemberId</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Lock</span><span class="o">(</span><span class="nc">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">MemberId</span> <span class="n">memberId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="821-선점-잠금과-교착-상태">8.2.1 선점 잠금과 교착 상태</h3>
<p>다음 상황은 교착 상태에 빠진다.</p>
<ol>
  <li>스레드 1: 🐳 애그리거트에 대한 선점 잠금 구함</li>
  <li>스레드 2: 🦍 애그리거트에 대한 선점 잠금 구함</li>
  <li>스레드 1: 🦍 애그리거트에 대한 선점 잠금 시도</li>
  <li>스레드 2: 🐳 애그리거트에 대한 선점 잠금 시도</li>
</ol>

<p><br /></p>

<p><strong>해결 방법</strong><br />
힌트를 제공해 최대 대기시간을 지정한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// JPA</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">hints</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">hints</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"javax.persistence.lock.timeout"</span><span class="o">,</span> <span class="mi">2000</span><span class="o">);</span>
<span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">orderNo</span><span class="o">,</span> <span class="nc">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">,</span> <span class="n">hints</span><span class="o">);</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 스프링 데이터 JPA</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberREpository</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">MemberId</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Lock</span><span class="o">(</span><span class="nc">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span>
    <span class="nd">@QueryHints</span><span class="o">({</span>
        <span class="nd">@QueryHint</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"javax.persistence.lock.timeout"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"2000"</span><span class="o">)</span>
    <span class="o">})</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">MemberId</span> <span class="n">memberId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>DBMS에 따라 교착 상태에 빠진 커넥션을 처리하는 방식이 다르다. 사용하는 DBMS에 대해 JPA가 어떤 식으로 대기시간을 처리하는지 반드시 확인해야 한다.</p>

<h2 id="83-비선점-잠금">8.3 비선점 잠금</h2>
<p>선점 잠금으로 모든 트랜잭션 충돌 문제가 해결되는 것은 아니다</p>
<center><img src="/assets/images/posts/books/1/8_3_비선점잠금.png" alt="비선점잠금" width="60%" height="60%" /></center>

<p>비선점 잠금은 동시에 접근하는 것을 막는 대신 변경한 데이터를 실제 DBMS에 반영하는 시점에 변경 가능 여부를 확인하는 방식이다.</p>

<p>비선점 잠금을 구현하려면 애그리거트에 버전으로 사용할 숫자 타입 프로퍼티를 추가해야 한다. 애그리거트를 수정할 때마다 버전으로 사용할 프로퍼티 값이 1씩 증가한다.</p>

<center><img src="/assets/images/posts/books/1/8_3_비선점잠금트랜잭션.png" alt="비선점잠금트랜잭션" width="60%" height="60%" /></center>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// JPA</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"purchase_order"</span><span class="o">)</span>
<span class="nd">@Access</span><span class="o">(</span><span class="nc">AccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
    <span class="nd">@Version</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>JPA 엔티티가 변경되어 UPDATE 쿼리를 실행할 때 <code class="language-plaintext highlighter-rouge">@Version</code>에 명시한 필드를 이용해서 비선점 잠금 쿼리를 실행한다. 응용 서비스는 버전에 대해 알 필요가 없다.</p>

<p>트랜잭션 충돌이 발생하면 <code class="language-plaintext highlighter-rouge">OptimisticLockingFailureException</code>이 발생한다.</p>

<p><br /></p>

<p><strong>비선점 잠금 확장</strong></p>
<center><img src="/assets/images/posts/books/1/8_3_비선점잠금트랜잭션확장.png" alt="비선점잠금트랜잭션확장" width="60%" height="60%" /></center>

<p><br /></p>

<p>비선점 잠금 방식을 여러 트랜잭션으로 확장하려면 애그리거트 버전 정보를 응용 서비스에 전달한다. 응용 서비스는 전달받은 버전 값을 이용해서 애그리거트 버전과 일치하는지 확인하고, 일치하는 경우에만 기능을 수행한다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StartShippingRequest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">orderNumber</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 응용 서비스</span>
<span class="kd">public</span> <span class="nc">StartShippingService</span> <span class="o">{</span>

    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasRole('ADMIN')"</span><span class="o">)</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startShipping</span><span class="o">(</span><span class="nc">StartShippingRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="k">new</span> <span class="nc">OrderNo</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getOrderNumber</span><span class="o">()));</span>
        <span class="c1">// version 확인</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">order</span><span class="o">.</span><span class="na">matchVersion</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">VersionConflictException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="831-강제-버전-증가">8.3.1 강제 버전 증가</h3>
<p>기능 실행 도중 루트가 아닌 다른 엔티티의 값만 변경된다면, JPA는 루트 엔티티 버전 값을 증가시키지 않는다.</p>

<p>JPA는 이런 문제를 처리할 수 있도록 EntityManager#find() 메서드로 엔티티를 구할 때 강제로 버전 값을 증가시키는 잠금 모드를 지원한다. <code class="language-plaintext highlighter-rouge">LockModeType.OPTIMISTIC_FORCE_INCREMENT</code>를 사용하면 해당 엔티티의 상태가 변경되었는지에 상관없이 트랜잭션 종료 시점에 버전 값 증가 처리를 한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// JPA</span>
<span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">orderNo</span><span class="o">,</span> <span class="nc">LockModeType</span><span class="o">.</span><span class="na">OPTIMISTIC_FORCE_INCREMENT</span><span class="o">);</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 스프링 데이터 JPA</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberREpository</span> <span class="kd">extends</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">MemberId</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Lock</span><span class="o">(</span><span class="nc">LockModeType</span><span class="o">.</span><span class="na">OPTIMISTIC_FORCE_INCREMENT</span><span class="o">)</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">MemberId</span> <span class="n">memberId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="84-오프라인-선점-잠금">8.4 오프라인 선점 잠금</h2>
<p>누군가 수정 화면을 보고 있을 때 수정 화면 자체를 실행하지 못하게 하는 것이 오프라인 선점 잠금 방식이다.</p>
<center><img src="/assets/images/posts/books/1/8_4_오프라인선점잠금방식.png" alt="오프라인선점잠금방식" width="60%" height="60%" /></center>

<h3 id="841-오프라인-선점-잠금을-위한-lockmanager-인터페이스와-관련-클래스">8.4.1 오프라인 선점 잠금을 위한 LockManager 인터페이스와 관련 클래스</h3>
<p>필요 기능</p>
<ul>
  <li>잠금 선점 시도</li>
  <li>잠금 확인</li>
  <li>잠금 해제</li>
  <li>잠금 유효시간</li>
</ul>

<p>구현 코드는 <a href="https://product.kyobobook.co.kr/detail/S000001810495" target="_blank">책</a>에서 확인해주세요. 🔎</p>

<h3 id="842-db를-이용한-lockmanager-구현">8.4.2 DB를 이용한 LockManager 구현</h3>
<p>구현 코드는 <a href="https://product.kyobobook.co.kr/detail/S000001810495" target="_blank">책</a>에서 확인해주세요. 🔎</p>

<p><br />
<br />
<br /></p>

<h1 id="9-도메인-모델과-바운디드-컨텍스트">9. 도메인 모델과 바운디드 컨텍스트</h1>
<h2 id="91-도메인-모델과-경계">9.1 도메인 모델과 경계</h2>
<p>논리적으로 같은 존재처럼 보이지만 하위 도메인에 따라 다른 용어를 사용하는 경우도 있다.</p>
<center><img src="/assets/images/posts/books/1/9_1_하위도메인별용어.png" alt="하위도메인별용어" width="80%" height="80%" /></center>

<p>이렇게 하위 도메인마다 같은 용어라도 의미가 다르고 같은 대상이라도 지칭하는 용어가 다를 수 있기 때문에 한개의 모델로 모든 하위 도메인을 표현하려는 시도는 올바른 방법이 아니며 표현할 수도 없다.</p>

<p><strong>모델은 특정한 컨텍스트(문맥) 하에서 완전한 의미를 갖는다</strong>. 같은 제품이라도 카탈로그 컨텍스트와 재고 컨텍스트에서 의미가 서로 다르다. 이렇게 <strong>구분되는 경계를 갖는 컨텍스트를 DDD에서는 바운디드 컨텍스트(Bounded Context)라고 부른다</strong>.</p>

<h2 id="92-바운디드-컨텍스트">9.2 바운디드 컨텍스트</h2>
<ul>
  <li>도메인 모델의 경계를 결정한다.</li>
  <li>용어를 기준으로 구분한다.</li>
  <li>한 개의 바운디드 컨텍스트는 논리적으로 한 개의 모델을 갖는다.</li>
  <li>한 개의 바운디드 컨텍스트가 여러 하위 도메인을 포함하더라도, 하위 도메인마다 구분되는 패키지를 갖도록 구현해야 한다.</li>
</ul>

<p><br /></p>

<p><strong>아직 명확하게 구분되지 않은 경우 두 하위 도메인을 하나의 바운디드 컨텍스트에서 구현하기도 한다.</strong><br />
<img src="/assets/images/posts/books/1/9_2_바운디드컨텍스트.png" alt="바운디드컨텍스트" width="70%" height="70%" /></p>

<p><br /></p>

<p><strong>한 개의 바운디드 컨텍스트가 여러 하위 도메인을 포함하더라도, 하위 도메인마다 구분되는 패키지를 갖도록 구현해야 한다.</strong><br />
<img src="/assets/images/posts/books/1/9_2_바운디드컨텍스트2.png" alt="바운디드컨텍스트" width="70%" height="70%" /></p>

<p><br /></p>

<p><strong>같은 상품이라도 각자 구현하는 하위 도메인에 맞는 모델을 갖는다.</strong><br />
<img src="/assets/images/posts/books/1/9_2_바운디드컨텍스트3.png" alt="바운디드컨텍스트" width="70%" height="70%" /></p>

<h2 id="93-바운디드-컨텍스트-구현">9.3 바운디드 컨텍스트 구현</h2>
<p>바운디드 컨텍스트는 도메인 기능을 사용자에게 제공하는 데 필요한 표현 영역, 응용 서비스, 인프라스트럭처, 테이블 영역을 포함한다.</p>
<center><img src="/assets/images/posts/books/1/9_3_바운디드컨텍스트영역.png" alt="바운디드컨텍스트영역" width="70%" height="70%" /></center>

<p><br />
<br /></p>

<p>CQRS (Command Query Responsibility Segregation, 명령 조회 책임 분리) 패턴을 사용할 수도 있다.</p>
<center><img src="/assets/images/posts/books/1/9_3_바운디드컨텍스트CQRS.png" alt="바운디드컨텍스트CQRS" width="60%" height="60%" /></center>

<p><br />
<br /></p>

<p>바운디드 컨텍스트는 UI를 갖지 않을 수도 있다.</p>
<center><img src="/assets/images/posts/books/1/9_3_바운디드컨텍스트UI미포함.png" alt="바운디드컨텍스트UI미포함" width="60%" height="60%" /></center>

<p><br />
<br /></p>

<p>바운디드 컨텍스트는 UI서버를 통해 간접적으로 브라우저와 통신할 수도 있다. 여기서 UI서버는 파사드 역할을 수행한다.</p>
<center><img src="/assets/images/posts/books/1/9_3_바운디드컨텍스트UI서버.png" alt="바운디드컨텍스트UI서버" width="60%" height="60%" /></center>

<h2 id="94-바운디드-컨텍스트-간-통합">9.4 바운디드 컨텍스트 간 통합</h2>
<p>바운디드 컨텍스트 간 통합이 필요할 때도 있다.</p>

<p><strong>REST API를 이용한 직접 통합</strong></p>
<ul>
  <li>통신</li>
</ul>

<p><img src="/assets/images/posts/books/1/9_4_바운디드컨텍스트간통합.png" alt="바운디드컨텍스트간통합" width="80%" height="80%" /></p>

<p><br /></p>

<ul>
  <li>도메인에 맞는 모델로 변환</li>
</ul>

<p><img src="/assets/images/posts/books/1/9_4_바운디드컨텍스트간통합2.png" alt="바운디드컨텍스트간통합" width="80%" height="80%" /></p>

<p><br />
<br /></p>

<p><strong>메시지 큐를 사용하여 통합</strong>
<img src="/assets/images/posts/books/1/9_4_바운디드컨텍스트간통합3.png" alt="바운디드컨텍스트간통합" width="80%" height="80%" /></p>

<p><img src="/assets/images/posts/books/1/9_4_바운디드컨텍스트간통합4.png" alt="바운디드컨텍스트간통합" width="80%" height="80%" /></p>

<p><br />
<br /></p>

<p><strong>마이크로서비스와 바운디드 컨텍스트</strong><br />
마이크로서비스는 애플리케이션을 작은 서비스로 나누어 개발하는 아키텍처 스타일이다. 개별 서비스를 독립된 프로세스로 실행하고 각 서비스가 REST API나 메시징을 이용해서 통신하는 구조를 갖는다.</p>

<p>바운디드 컨텍스트를 마이크로서비스로 구현하면 자연스럽게 컨텍스트별로 모델이 분리된다. 마이크로서비스마다 프로젝트를 생성하므로 <strong>바운디드 컨텍스트마다 프로젝트를 만들게 된다</strong>. 이것은 코드 수준에서 모델을 분리하여 두 바운디드 컨텍스트의 모델이 섞이지 않도록 해준다.</p>

<h2 id="95-바운디드-컨텍스트-간-관계">9.5 바운디드 컨텍스트 간 관계</h2>
<p>바운디드 컨텍스트는 어떤 식으로든 연결되기 때문에 두 바운디드 컨텍스트는 다양한 방식으로 관계를 맺는다.</p>

<p><strong>REST API</strong><br />
<img src="/assets/images/posts/books/1/9_5_바운디드컨텍스트관계.png" alt="바운디드컨텍스트간통합" width="80%" height="80%" /></p>

<p><br />
<br /></p>

<p><strong>단일 API</strong><br />
<img src="/assets/images/posts/books/1/9_5_바운디드컨텍스트관계2.png" alt="바운디드컨텍스트간통합" width="80%" height="80%" /></p>

<p><br />
<br /></p>

<p><strong>독립 방식</strong><br />
그냥 서로 통합하지 않는 방식이다. 서로 독립적으로 모델을 발전 시킨다. 하지만 규모가 커질수록 한계가 있으므로 그 전에 두 바운디드 컨텍스트를 통합해야 한다.</p>

<p><img src="/assets/images/posts/books/1/9_5_바운디드컨텍스트관계3.png" alt="바운디드컨텍스트간통합" width="80%" height="80%" /></p>

<p><img src="/assets/images/posts/books/1/9_5_바운디드컨텍스트관계4.png" alt="바운디드컨텍스트간통합" width="80%" height="80%" /></p>

<h2 id="96-컨텍스트-맵">9.6 컨텍스트 맵</h2>
<p>개별 바운디드 컨텍스트에 매몰되면 전체를 보지 못할 때가 있다. 전체 바운디드 컨텍스트 간 관계를 볼 수 있는 지도가 필요한데 그것이 바로 컨텍스트 맵이다.</p>

<p><img src="/assets/images/posts/books/1/9_6_컨텍스트맵.png" alt="컨텍스트맵" width="80%" height="80%" /></p>

<p><br />
<br />
<br /></p>

<h1 id="10-이벤트">10. 이벤트</h1>
<h2 id="101-시스템-간-강결합-문제">10.1 시스템 간 강결합 문제</h2>
<ul>
  <li>트렌젝션 문제</li>
  <li>외부 서비스의 성능에 영향을 받음</li>
  <li>설계상 문제 (로직이 섞임)</li>
  <li>기능 추가의 어려움</li>
</ul>

<h2 id="102-이벤트-개요">10.2 이벤트 개요</h2>
<p>여기서 사용되는 이벤트라는 용어는 ‘과거에 벌어진 어떤 것’을 의미한다.</p>
<ul>
  <li>이벤트 발생</li>
  <li>이벤트에 반응하여 동작 수행</li>
</ul>

<h3 id="1021-이벤트-관련-구성요소">10.2.1 이벤트 관련 구성요소</h3>
<ul>
  <li>이벤트</li>
  <li>이벤트 생성 주체</li>
  <li>이벤트 디스패처 (퍼블리셔)</li>
  <li>이벤트 핸들러 (구독자)</li>
</ul>

<p><img src="/assets/images/posts/books/1/10_2_이벤트구성요소.png" alt="이벤트구성요소" width="80%" height="80%" /></p>

<p>도메인 모델에서 이벤트 생성 주체는 엔티티, 밸류, 도메인 서비스와 같은 도메인 객체이다. 도메인 객체는 도메인 로직을 실행해서 상태가 바뀌면 관련 이벤트를 발생시킨다.</p>

<h3 id="1022-이벤트의-구성">10.2.2 이벤트의 구성</h3>
<p>이벤트는 발생한 이벤트에 대한 정보를 담는다.</p>
<ul>
  <li>이벤트 종류: 클래스 이름으로 이벤트 종류를 표현</li>
  <li>이벤트 발생 시간</li>
  <li>추가 데이터: 주문번호, 시규배송지 정보 등 이벤트와 관련된 정보</li>
</ul>

<h3 id="1023-이벤트-용도">10.2.3 이벤트 용도</h3>
<ul>
  <li>후처리를 실행하기 위한 트리거</li>
  <li>서로 다른 시스템 간의 데이터 동기화</li>
</ul>

<p><img src="/assets/images/posts/books/1/10_2_이벤트용도.png" alt="이벤트용도" width="80%" height="80%" /></p>

<h3 id="1024-이벤트-장점">10.2.4 이벤트 장점</h3>
<ul>
  <li>서로 다른 도메인 로직이 섞이는 것을 방지</li>
  <li>도메인 로직에 영향 없이 기능 확장</li>
</ul>

<p><img src="/assets/images/posts/books/1/10_2_이벤트장점.png" alt="이벤트장점" width="80%" height="80%" /></p>

<h2 id="103-이벤트-핸들러-디스패처-구현">10.3 이벤트, 핸들러, 디스패처 구현</h2>
<p>이벤트와 관련된 코드</p>
<ul>
  <li>이벤트 클래스: 이벤트를 표현한다.</li>
  <li>디스패처: 스프링이 제공하는 ApplicationEventPublisher를 이용한다.</li>
  <li>Events: 이벤트를 발행한다. 이벤트 발행을 위해 ApplicationEventPublisher를 사용한다.</li>
  <li>이벤트 핸들러: 이벤트를 수신해서 처리한다. 스프링이 제공하는 기능을 사용한다.</li>
</ul>

<h3 id="1031-이벤트-클래스">10.3.1 이벤트 클래스</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 공통 추상 클래스</span>
<span class="kn">package</span> <span class="nn">com.myshop.common.event</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Event</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Event</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timestamp</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderCanceledEvent</span> <span class="kd">extends</span> <span class="nc">Event</span> <span class="o">{</span>

    <span class="c1">// 이벤트는 핸들러에서 이벤트를 처리하는 데 필요한 데이터를 포함</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">orderNumber</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OrderCanceledEvent</span><span class="o">(</span><span class="nc">String</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">orderNumber</span> <span class="o">=</span> <span class="n">number</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="1032-events-클래스와-applicationeventpublisher">10.3.2 Events 클래스와 ApplicationEventPublisher</h3>
<p>이벤트 발생과 출판을 위해 스프링이 제공하는 <code class="language-plaintext highlighter-rouge">ApplicationEventPublisher</code>를 사용한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 설정</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EventsConfiguration</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">InitializingBean</span> <span class="nf">eventsInitializer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">Events</span><span class="o">.</span><span class="na">setPublisher</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Events는 ApplicationEventPublisher를 사용해서 이벤트를 발생</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Events</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ApplicationEventPublisher</span> <span class="n">publisher</span><span class="o">;</span>

    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setPublisher</span><span class="o">(</span><span class="nc">ApplicationEventPublisher</span> <span class="n">publisher</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Events</span><span class="o">.</span><span class="na">publisher</span> <span class="o">=</span> <span class="n">publisher</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">raise</span><span class="o">(</span><span class="nc">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">publisher</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">publisher</span><span class="o">.</span><span class="na">publishEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="1033-이벤트-발생과-이벤트-핸들러">10.3.3 이벤트 발생과 이벤트 핸들러</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 이벤트 발생</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cancel</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span><span class="na">생략</span><span class="o">...</span>
        <span class="nc">Events</span><span class="o">.</span><span class="na">raise</span><span class="o">(</span><span class="k">new</span> <span class="nc">OrderCanceledEvent</span><span class="o">(</span><span class="n">number</span><span class="o">.</span><span class="na">getNumber</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 이벤트 핸들러</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderCanceledEventHandler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">RefundService</span> <span class="n">refundService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OrderCanceledEventHandler</span><span class="o">(</span><span class="nc">RefundService</span> <span class="n">refundService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">refundService</span> <span class="o">=</span> <span class="n">refundService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@EventListener</span><span class="o">(</span><span class="nc">OrderCanceledEvent</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">OrderCanceledEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">refundService</span><span class="o">.</span><span class="na">refund</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getOrderNumber</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="1034-흐름-정리">10.3.4 흐름 정리</h3>
<p><img src="/assets/images/posts/books/1/10_3_이벤트흐름.png" alt="이벤트흐름" width="80%" height="80%" /></p>

<h2 id="104-동기-이벤트-처리-문제">10.4 동기 이벤트 처리 문제</h2>
<p>동기 이벤트 처리는 다음과 같은 문제가 발생한다.</p>
<ul>
  <li>외부 연동 과정에서 익셉션이 발생하면 트랜잭션 처리는?</li>
  <li>이벤트 처리하는 코드가 느려지거나 익셉션이 발생하면?</li>
</ul>

<h2 id="105-비동기-이벤트-처리">10.5 비동기 이벤트 처리</h2>
<p>비동기 이벤트 처리로 해결한다.</p>
<ul>
  <li>로컬 핸들러를 비동기로 실행하기</li>
  <li>메시지 큐를 사용하기</li>
  <li>이벤트 저장소와 이벤트 포워더 사용하기</li>
  <li>이벤트 저장소와 이벤트 제공 API 사용하기</li>
</ul>

<h3 id="1051-로컬-핸들러-비동기-실행">10.5.1 로컬 핸들러 비동기 실행</h3>
<p>이벤트 핸들러를 별도 스레드로 실행한다. 스프링이 제공하는 <code class="language-plaintext highlighter-rouge">@Async</code> 에너테이션을 사용하면 손쉽게 비동기로 이벤트 핸들러를 실행할 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableAsync</span>  <span class="c1">// 기능 활성화</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShopApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">ShopApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 핸들러</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderCanceledEventHandler</span> <span class="o">{</span>

    <span class="nd">@Async</span> <span class="c1">// @Async 에너테이션 사용</span>
    <span class="nd">@EventListener</span><span class="o">(</span><span class="nc">OrderCanceledEvent</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">OrderCanceledEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">refundService</span><span class="o">.</span><span class="na">refund</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getOrderNumber</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="1052-메시징-시스템을-이용한-비동기-구현">10.5.2 메시징 시스템을 이용한 비동기 구현</h3>
<p>Kafka나 RabbitMQ와 같은 메시징 시스템을 사용</p>
<ul>
  <li>RabbitMQ
    <ul>
      <li>글로벌 트랜잭션 지원</li>
    </ul>
  </li>
  <li>Kafka
    <ul>
      <li>글로벌 트랜잭션 지원 X</li>
      <li>다른 메시징 시스템에 비해 <strong>높은 성능</strong></li>
    </ul>
  </li>
</ul>

<p><img src="/assets/images/posts/books/1/10_5_이벤트메시지큐.png" alt="이벤트메시지큐" width="80%" height="80%" /></p>

<h3 id="1053-이벤트-저장소를-이용한-비동기-처리">10.5.3 이벤트 저장소를 이용한 비동기 처리</h3>
<p>이벤트를 일단 DB에 저장한 뒤에 별도 프로그램을 이용해서 이벤트 핸들러에 전달</p>

<p><img src="/assets/images/posts/books/1/10_5_이벤트저장소이용포워더.png" alt="이벤트저장소이용포워더" width="80%" height="80%" /></p>

<p><img src="/assets/images/posts/books/1/10_5_이벤트저장소이용API.png" alt="이벤트저장소이용API" width="80%" height="80%" /></p>

<p><br /></p>

<p>API방식과 포워더 방식의 차이점은 이벤트를 전달하는 방식에 있다.</p>
<ul>
  <li>포워더
    <ul>
      <li>포워더를 이용해서 이벤트를 외부에 전달.</li>
      <li>이벤트를 어디까지 처리했는지 추적하는 역할이 포워더에 있다.</li>
    </ul>
  </li>
  <li>API
    <ul>
      <li>외부 핸들러가 API 서버를 통해 이벤트 목록을 가져감.</li>
      <li>이벤트를 어디까지 처리했는지 추적하는 역할이 외부 핸들러에 있다.</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<p><strong>구현 방법은 책 참고</strong><br />
…생략…😅</p>

<p><br /></p>

<p><strong>자동 증가 칼럼 주의 사항</strong><br />
트랜잭션 커밋 시점에 따른 자동 증가 칼럼 문제<br />
<a href="https://javacan.tistory.com/entry/MySQL-auto-inc-col-gotcha" target="_blank">자동 증가 칼럼 주의 사항 링크</a></p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 트랜잭션 커밋 시점에 따른 ID 값
시간 흐름 ---&gt;  
트랜잭션 1: 1, 2       5, 6
트랜잭션 2:       3, 4      7, 8
</code></pre></div></div>

<h2 id="106-이벤트-적용-시-추가-고려-사항">10.6 이벤트 적용 시 추가 고려 사항</h2>
<p>이벤트 적용 시 다음 고려사항을 생각해본다.</p>
<ul>
  <li><strong>이벤트 소스를 EventEntry에 추가할지?</strong>
    <ul>
      <li>EventEntry는 이벤트 발생 주체에 대한 정보를 갖지 않는다.</li>
      <li>특정 주체가 발생시킨 이벤트만 조회하는 기능을 구현할 수 없다.</li>
      <li>이 기능을 구현하려면 이벤트에 발생 주체 정보를 추가해야 한다.</li>
    </ul>
  </li>
  <li><strong>포워더에서 전송 실패를 얼마나 허용할지?</strong>
    <ul>
      <li>포워더는 이벤트 전송에 실패하면 실패한 이벤트부터 다시 읽어와 전송을 시도한다.</li>
      <li>특정 이벤트가 계속 실패한다면?</li>
      <li>실패한 이벤트의 재전송 횟수 제한을 두어야 한다.</li>
      <li>실패한 이벤트는 실패용 DB나 메시지 큐에 저장한다.</li>
    </ul>
  </li>
  <li><strong>이벤트 손실은?</strong>
    <ul>
      <li>이벤트 저장소를 사용하면 이벤트 발생과 이벤트 저장을 한 트랜잭션으로 처리하기 때문에 트랜잭션에 성공하면 이벤트가 저장소에 보관된다는 것을 보장할 수 있다.</li>
      <li>이벤트를 비동기로 처리할 경우 이벤트 처리에 실패하면 이벤트를 유실하게 된다.</li>
    </ul>
  </li>
  <li><strong>이벤트 순서는?</strong>
    <ul>
      <li>이벤트 발생 순서대로 외부 시스템에 전달해야 할 경우는 이벤트 저장소를 사용한다.</li>
      <li>메시징 시스템은 사용 기술에 따라 이벤트 발생 순서와 메시지 순서가 다를 수 있다.</li>
    </ul>
  </li>
  <li><strong>이벤트 재처리는?</strong>
    <ul>
      <li>이벤트의 순번을 기억한다.</li>
      <li>이벤트 멱등성으로 처리한다</li>
    </ul>
  </li>
</ul>

<p><strong>멱등성이란?</strong><br />
연산을 여러번 적용해도 결과가 달라지지 않는 성질을 멱등성이라고 한다.</p>

<h3 id="1061-이벤트-처리와-db-트랜잭션-고려">10.6.1 이벤트 처리와 DB 트랜잭션 고려</h3>
<p>이벤트 처리를 동기로 하든 비동기로 하든 이벤트 처리 실패와 <strong>트랜잭션 실패를 함께 고려</strong>해야 한다. 트랜잭션 실패와 이벤트 처리 실패 모두 고려하면 복잡해지므로 경우의 수를 줄이면 도움이 된다. 경우의 수를 줄이는 방법은 <strong>트랜잭션이 성공할 때만 이벤트 핸들러를 실행하는 것이다.</strong></p>

<p>스프링은 <code class="language-plaintext highlighter-rouge">@TransactionalEventListener</code> 에너테이션을 지원한다. 이 애너테이션은 트랜잭션 상태에 따라 이벤트 핸들러를 실행할 수 있게 한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@TransactionalEventListener</span><span class="o">(</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="nc">OrderCanceledEvent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="nc">TransactionPhase</span><span class="o">.</span><span class="na">AFTER_COMMIT</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">OrderCanceledEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">refundService</span><span class="o">.</span><span class="na">refund</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getOrderNumber</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br />
<br />
<br /></p>

<h1 id="11-cqrs">11. CQRS</h1>
<h2 id="111-단일-모델의-단점">11.1 단일 모델의 단점</h2>
<p>조회 기능을 구현하려면 여러 애그리거트에서 데이터를 가져와야 할 경우가 많다. 이 때 식별자를 이용한 참조 방식이든, 직접 참조하는 방식이든 고민해야 할 것들이 많다. 이는 구현 복잡도를 높인다.</p>

<p>이런 구현 복잡도를 낮추는 간단한 방법이 바로 CQRS (Command Query Responsibility Segregation, 명령 조회 책임 분리)다.</p>

<h2 id="112-cqrs">11.2 CQRS</h2>

<p><img src="/assets/images/posts/books/1/11_2_CQRS패턴.png" alt="CQRS패턴" width="80%" height="80%" /></p>

<p><br /></p>

<p><strong>CQRS를 사용하면 각 모델에 맞는 구현 기술을 선택할 수 있다.</strong></p>

<p><img src="/assets/images/posts/books/1/11_2_CQRS_3.png" alt="CQRS" width="70%" height="70%" /></p>

<p><img src="/assets/images/posts/books/1/11_2_CQRS_2.png" alt="CQRS_2" width="70%" height="70%" /></p>

<p>단순히 데이터를 읽어와 조회하는 기능은 응용 서비스를 제외할 수도 있다.</p>

<p><br /></p>

<p><strong>CQRS를 사용하면 각 모델에 맞는 데이터 저장소를 선택할 수 있다.</strong></p>

<p><img src="/assets/images/posts/books/1/11_2_CQRS_4.png" alt="CQRS" width="70%" height="70%" /></p>

<p>명령 모델은 트랜잭션을 지원하는 RDBMS를 사용하고, 조회 모델은 조회 성능이 좋은 메모리 기반 NoSQL을 사용할 수 있다.</p>

<h3 id="1121-웹과-cqrs">11.2.1 웹과 CQRS</h3>
<p>일반적인 웹 서비스는 <strong>상태를 변경하는 요청보다 상태를 조회하는 요청이 많다</strong>. 대규모 트래픽이 발생하는 웹 서비스는 알게 모르게 CQRS를 적용하게 된다. <strong>조회 속도를 높이기 위해 별도 처리를 하고 있다면 CQRS를 적용하자</strong>. 이를 통해 <strong>조회 기능 때문에 명령 모델이 복잡해지는 것을 막을 수 있고, 명령 모델에 관계없이 조회 기능에 특화된 구현 기법을 보다 쉽게 적용할 수 있다</strong>.</p>

<h3 id="1122-cqrs-장단점">11.2.2 CQRS 장단점</h3>
<ul>
  <li>장점
    <ul>
      <li>명령 모델을 구현할 때 도메인 자체에 집중할 수 있다.</li>
      <li>조회 성능 향상에 유리</li>
    </ul>
  </li>
  <li>단점
    <ul>
      <li>구현해야 할 코드가 더 많다.</li>
      <li>더 많은 구현 기술이 필요하다.</li>
    </ul>
  </li>
</ul>

<p>장단점을 고려해 CQRS 패턴 도입 여부를 결정한다. 도메인이 복잡하지 않은데 CQRS를 도입하면 유지 비용만 높아진다. 반면 트래픽이 높은 서비스인데 단일 모델을 고집하면 유지 보수 비용이 오히려 높아질 수 있으므로 CQRS 도입을 고려하자.</p>

<p><br />
<br />
<br />
<br /></p>

<p><strong>감사합니다</strong> 🙇🏻‍♂️</p>

<ul>
  <li><a href="https://product.kyobobook.co.kr/detail/S000001810495" target="_blank">도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지</a></li>
  <li><a href="https://github.com/madvirus/ddd-start2" target="_blank">예제 코드</a></li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#books" class="page__taxonomy-item p-category" rel="tag">books</a><span class="sep">, </span>
    
      <a href="/tags/#ddd" class="page__taxonomy-item p-category" rel="tag">DDD</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#books" class="page__taxonomy-item p-category" rel="tag">books</a><span class="sep">, </span>
    
      <a href="/categories/#etc" class="page__taxonomy-item p-category" rel="tag">etc</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time class="dt-published" datetime="2023-01-09T00:00:00+09:00">2023-01-09</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%F0%9F%93%96+%EB%8F%84%EB%A9%94%EC%9D%B8+%EC%A3%BC%EB%8F%84+%EA%B0%9C%EB%B0%9C+%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0%3A+DDD+%ED%95%B5%EC%8B%AC+%EA%B0%9C%EB%85%90+%EC%A0%95%EB%A6%AC%EB%B6%80%ED%84%B0+%EA%B5%AC%ED%98%84%EA%B9%8C%EC%A7%80%20http%3A%2F%2Flocalhost%3A4000%2Fetc%2Fbooks%2F%25EB%258F%2584%25EB%25A9%2594%25EC%259D%25B8%25EC%25A3%25BC%25EB%258F%2584%25EA%25B0%259C%25EB%25B0%259C%25EC%258B%259C%25EC%259E%2591%25ED%2595%2598%25EA%25B8%25B0%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fetc%2Fbooks%2F%25EB%258F%2584%25EB%25A9%2594%25EC%259D%25B8%25EC%25A3%25BC%25EB%258F%2584%25EA%25B0%259C%25EB%25B0%259C%25EC%258B%259C%25EC%259E%2591%25ED%2595%2598%25EA%25B8%25B0%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fetc%2Fbooks%2F%25EB%258F%2584%25EB%25A9%2594%25EC%259D%25B8%25EC%25A3%25BC%25EB%258F%2584%25EA%25B0%259C%25EB%25B0%259C%25EC%258B%259C%25EC%259E%2591%25ED%2595%2598%25EA%25B8%25B0%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/os/mac/hotkey/" class="pagination--pager" title="MAC 단축키 모음 💻
">이전</a>
    
    
      <a href="/etc/books/%EC%9E%90%EB%B0%94-ORM-%ED%91%9C%EC%A4%80-JPA-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/" class="pagination--pager" title="📖 자바 ORM 표준 JPA 프로그래밍
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">다른 읽을거리</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/etc/books/%EC%9E%90%EB%B0%94-ORM-%ED%91%9C%EC%A4%80-JPA-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/" rel="permalink">📖 자바 ORM 표준 JPA 프로그래밍
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-01-16T00:00:00+09:00">2023-01-16</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">자바 ORM 표준 JPA 프로그래밍 책을 읽고 내용을 아주 간단하게 정리한 글입니다. 책에는 자세한 설명과 예제가 많으니 꼭 구입해서 읽는것을 추천합니다~👍
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/os/mac/hotkey/" rel="permalink">MAC 단축키 모음 💻
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-01-08T00:00:00+09:00">2023-01-08</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">⌨ 일반 단축키

  화면 잠금: Control + Command + Q
  복제: Command + x
  다시찾기: Command + G
  윈도우 최소화: Command + M
  프린트: Command + P
  붙여넣기: Command + V
  모두선택: Command ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/etc/education/%EC%9A%B0%EC%95%84%ED%95%9C%ED%85%8C%ED%81%AC%EC%BA%A0%ED%94%84pro5%EA%B8%B0-8%EC%A3%BC%EC%B0%A8/" rel="permalink">우아한테크캠프 Pro 5기 - 8주차 (안정적인 서비스 만들기)
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-01-08T00:00:00+09:00">2023-01-08</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">2022년 10월 24일 ~ 2022년 12월 23일
우아한테크캠프 Pro 5기를 경험한 내용 기록입니다.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/etc/education/%EC%9A%B0%EC%95%84%ED%95%9C%ED%85%8C%ED%81%AC%EC%BA%A0%ED%94%84pro5%EA%B8%B0-7%EC%A3%BC%EC%B0%A8/" rel="permalink">우아한테크캠프 Pro 5기 - 7주차 (레거시 코드 리팩터링)
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-01-08T00:00:00+09:00">2023-01-08</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">2022년 10월 24일 ~ 2022년 12월 23일
우아한테크캠프 Pro 5기를 경험한 내용 기록입니다.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    

    
      
        
      
        
      
        
          <li><a href="https://github.com/sangjaeoh" rel="nofollow noopener noreferrer"><i class="fas fa-link" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Sangjae Oh. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/etc/books/%EB%8F%84%EB%A9%94%EC%9D%B8%EC%A3%BC%EB%8F%84%EA%B0%9C%EB%B0%9C%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/etc/books/도메인주도개발시작하기"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://stack-o-flow.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  






    <aside class="sidebar__home">
      <a href="/">
        <div style="font-size: 0.5rem;"><i class="fas fa-h-square fa-5x"></i></div>
      </a>
    </aside>

    <aside class="sidebar__top">
      <a href="#site-nav">
        <div style="font-size: 0.5rem;"><i class="fas fa-caret-square-up fa-5x"></i></div>
      </a>
    </aside>

    <aside class="sidebar__bottom">
      <a href="#footer">
        <div style="font-size: 0.5rem;"><i class="fas fa-caret-square-down fa-5x"></i></div>
      </a>
    </aside>

  </body>
</html>
