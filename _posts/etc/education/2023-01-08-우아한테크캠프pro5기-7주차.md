---
layout: single
title: "우아한테크캠프 Pro 5기 - 7주차 (레거시 코드 리팩터링)"
categories: [etc, education]
tag: [우아한테크캠프 pro 5기]
author_profile: true
toc: true
toc_sticky: true
---

*2022년 10월 24일 ~ 2022년 12월 23일*  
우아한테크캠프 Pro 5기를 경험한 내용 기록입니다.

## 🙇🏻‍♂️ 미션 설명
레거시 프로젝트를 리팩터링하는 미션

## 🎯 학습 목표
- 레거시 프로젝트를 리팩터링하는 경험을 통해 서비스를 안정적으로 운영하면서 레거시 코드를 리팩터링할 수 있는 역량을 키운다.
- 프로젝트를 만드는 단계에서 끝나는 것이 아니라 프로젝트를 완료한 후 일정 기간 유지보수를 함으로써 레거시 코드를 리팩터링하는 경험을 쌓는다.

## 📖 강의 내용
도메인 주도 설계 및 아키텍처에 대해 설명합니다.

**책 추천**  
- [도메인 주도 개발 시작하기: DDD 핵심 개념 정리부터 구현까지](https://product.kyobobook.co.kr/detail/S000001810495){:target="_blank"}
- [오브젝트](https://product.kyobobook.co.kr/detail/S000001766367){:target="_blank"}



## 📝 미션 후기
우테캠 Pro 과정의 사실상 최종 보스... 지금까지의 미션들은 사실상 이번 미션을 하기 위한 준비단계라 여겨도 무방하다고 생각된다.

이번 미션은 JDBC 사용과 서비스에서 모든 비즈니스 구현이라는 우리가 흔히 아는 레거시 프로젝트를 지금까지 배운 ATDD, DDD, JPA, 객체지향 생활 체조 원칙, 의존관계 원칙 등을 활용하여 리팩터링하는 미션이었다.

처음 딱 레거시 프로젝트를 열었을 때 나름 정리가 잘 되어있어서 금방 리팩터링 할 수도 있지 않을까...? 란 쓰레기같은 생각도 했었다 😂

1 단계. 테스트를 통한 코드 보호를 위해 우선 기존 레거시 코드의 모든 비지니스 로직에 대해 테스트 코드를 작성하였다. 뭐... 여기까지는 수월했다.  

2 단계. 서비스 리팩터링을 시작하고 지옥이 시작되었다...  
우선은 도메인 분리를 어떻게 할까 생각을 했다. 처음부터 완벽하게 분리할 수 있으면 좋겠지만 그러기는 힘들었고, 일단 레거시 프로젝트에서 나뉘어져있던 패키지 구조대로 분리하기로 하였다. 프로젝트를 분석했을 때 가장 의존관계가 적은 패키지부터 차근차근 리팩터링을 하기 시작하였다. Entity로 매핑하고, 테스트 코드 작성하고, 비지니스로직을 서비스에서 도메인을 옮기고, 에러 수정하고, 리팩터링하고... 계속 반복하였다.  

처음에는 다른 패키지와의 의존관계가 별로 없어서 금방 리팩터링 되었지만 진행 하면 할수록 다른 패키지와의 의존관계가 늘어나고 리팩터링 할 때 마다 에러가 빵빵 터지기 시작하였다. ~~내 멘탈도 같이 터짐...~~  

이 때 가장 크게 와 닿았던 점은 테스트 코드의 중요성이었다. 테스트를 통한 코드 보호 덕분에 리팩터링을 할 때 내가 제대로 수정하고 있는지, 기능에 오류가 없는지 바로바로 확인할 수 있었다. 또 리팩터링을 진행하다 보면 이전 메소드의 기능이 무었이었는지 햇갈릴 경우가 있는데 이 때 테스트 코트를 봄으로써 기능들을 파악하기 수월하다는 장점도 있었다.  

3 단계. 의존성 리팩터링
의존성 리팩터링을 진행하면서 [\[우아한테크세미나\] 우아한객체지향](https://www.youtube.com/watch?v=dJ5C4qRqAgA){:target="_blank"} 영상을 출퇴근 시간에 계속 돌려봤다. 객체지향 의존성에 대해 정말 알기 쉽게 설명해 주어서 의존성 리팩터링을 하며 정말 많은 도움이 되었다. 
쉽게 술술 풀리면 좋았겠지만... 의존성 리팩터링을 하며 좀 애매한 부분도 있었다.  

예를 들자면 Product, Menu, MenuGroup 같은 경우 각각 생성되는 시기가 다르다. Product, MenuGroup은 독립적으로 생성될 수 있지만 Menu는 생성할 때 Product와 MenuGroup가 필요하다. 조회도 Product, MenuGroup는 독립적이지만 Menu는 Product, MenuGroup가 같이 필요하다. 이럴 때는 Product, Menu, MenuGroup를 한 패키지로 묶는게 맞는가? 떼는게 맞는가?  

다른 예로는 OrderTable과 TableGroup과의 관계도 이와 비슷했다. OrderTable은 독립적으로 생성되지만, TableGroup은 생성할 때 OrderTable가 필요하다. 그렇다고 OrderTable이 완전히 독립적이지도 않고 정책상 TableGroup 여부를 확인해야 한다. 이럴 때는 OrderTable, TableGroup를 한 패키지로 묶는게 맞는가? 떼는게 맞는가?  

도메인을 분리할 때 트렌젝션 단위로 분리한다고 한다면 전부 떼는게 맞는거 같기도 하면서, 그렇게 되면 너무 세세하게 분리하게 되어 오히려 독이 되는거 같고... 정하기 어려웠다. 😱

나의 경우에는 크게 product, menu, order, table로 패키지를 나누고 아래 그림과 같이 의존 관계를 맺었다.
![jwp_refactoring_step3_의존성](/assets/images/posts/jwp_refactoring_step3_의존성.png)

4 단계. 멀티 모듈 적용
이번 단계는 Gradle의 멀티 모듈을 이용해 3단계에서 분리했던 패키지들을 모듈로 분리하는 단계였다. 내 생각에는 최종적으로는 모듈 각각이 MSA로 분리되어야 하는데 이를 프로젝트 단위로 분리하는건 미션에서 진행할 수 없으니 Gradle의 멀티 모듈을 이용한게 아닌가 추측해본다. 🤔

이렇게 레거시 코드 리팩터링 미션을 4단계에 걸쳐 진행하였다. 이번 미션을 진행하면서 너무 잠이 부족해 커피를 하루에 3잔씩도 마셨다. 😱 그만큼 난이도도 높았고 시간도 부족한 미션이었다.  
그래도 이번 미션을 통해 도메인을 어떻게 설계하면 좋을지, 프로그래밍을 하면서 의존관계를 어떻게 맺어야 하는지에 대해 많이 생각해 볼 수 있어서 좋은 경험이 되었다.
~~도메인 설계를 해보면서 개인적으로 느낀점으로는 도메인 설계는 타고난 센스가 어느정도 필요한거 같다는 점이다 😂~~


이번 미션에서 나의 문제점은 도메인 설계를 제대로 했는지, 패키지간 의존관계를 제대로 맺었는지 확신이 안선다는 점이다. 뭔가 더 좋은 방법이 분명히 있을거 같은데...😂  
다른 문제점으로는 테스트 코드에서의 연관관계 분리를 제대로 하지 못해 모듈 분리할 때 엄청 힘들었다는 점이다.

위 문제점을 개선하기 위해 DDD관련 글을 읽고 공부, 연습을 많이 해봐야 할거같고, 테스트 코드 작성시에도 의존관계를 생각해야할 것 같다(TestFixtures등을 이용)

## 💾 저장소
[깃허브 저장소 링크](https://github.com/sangjaeoh/jwp-refactoring/tree/step4){:target="_blank"}